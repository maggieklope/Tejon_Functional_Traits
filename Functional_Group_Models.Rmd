---
title: "Functional_Group_Models"
author: "Maggie Klope"
date: "1/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(stats)
library(sjPlot)
library(FD)
library(DHARMa) #model diagnostics
library(glmmTMB) #model fitting
library(MuMIn) #model summaries and comparisons
library(emmeans) #post-hoc analyses
library(gt)
library(tibble)
library(lsmeans)
library(gridExtra)
library(multcomp)
library(car)
library(ggeffects)

other_traits <- read_csv("Datasheets/seed_mass_leaf_N.csv")

cwm_traits_adj <-  read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  mutate(weighted_la = leaf_area * Abundance) %>% #multiplying trait values by species abundance
  mutate(weighted_sla = sla * Abundance) %>% 
  mutate(weighted_ldmc = ldmc * Abundance) %>%
  mutate(weighted_seed_mass = seed_mass * Abundance) %>%
  mutate(weighted_n = leaf_n * Abundance) %>%
  group_by(climate, treatment, Block) %>% #grouping by climate, treatment, and block
  summarise_all(mean, na.rm = TRUE) %>% #finding the mean
  dplyr::select(climate, treatment, Block, weighted_la, weighted_sla, weighted_ldmc, weighted_seed_mass, weighted_n)

# log transformation for seed mass & leaf n
cwm_traits_adj <- cwm_traits_adj %>% 
  mutate(log_seed_mass = log(weighted_seed_mass)) %>% 
  mutate(log_n = log(weighted_n))

```

```{r}
cwm_functional <-  read_csv("~/github/Tejon_Functional_Traits/Datasheets/cwm_traits_updated.csv") %>%
  left_join(other_traits, by = "species_name") %>% 
  mutate(weighted_la = leaf_area * Abundance) %>% #multiplying trait values by species abundance
  mutate(weighted_sla = sla * Abundance) %>% 
  mutate(weighted_ldmc = ldmc * Abundance) %>%
  mutate(weighted_seed_mass = seed_mass * Abundance) %>%
  mutate(weighted_n = leaf_n * Abundance) %>%
  group_by(climate, treatment, Block, functional_group) %>% #grouping by climate, treatment, and block
  summarise_all(mean, na.rm = TRUE) %>% #finding the mean
  dplyr::select(climate, treatment, functional_group, weighted_la, weighted_sla, weighted_ldmc, weighted_seed_mass, weighted_n)


cwm_functional_2 <- read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  dplyr::select(climate, treatment, Block, functional_group, Abundance) %>% 
  dplyr::filter(Block == "A" | Block ==  "D" | Block ==  "G") %>% 
  group_by(climate, functional_group) %>% 
  summarise(Total_Abundance = sum(Abundance))

ggplot(cwm_functional_2, aes(x = "", y = Total_Abundance, fill = functional_group)) +
  geom_bar(stat="identity", width=1, color = "white") +
  coord_polar("y", start = 0) +
  facet_wrap(~climate) +
  theme_void() +
  labs(fill = "Functional Group:") +
  scale_fill_manual(values = c("#c7eae5", "#b8e186", "#dfc27d")) +
  theme(plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill = "white", size = 0)) +
  theme(legend.position="bottom")
  
# ggsave("plant_communit_piechart.png", path = "~/github/Tejon_Functional_Traits/Figures", width = 9, height = 7, bg = "transparent")

#  barplot showing all climate/treatments
cwm_functional %>%
  pivot_longer(cols = weighted_la:weighted_n,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(traits ~ functional_group, scales = "free")

# ggsave("cwm_by_functional_group_barchart.png", path = "~/github/Tejon_Functional_Traits/Figures", width = 9, height = 7, bg = "transparent")

grass <- cwm_functional %>% 
  filter(functional_group == "grass")

forb <- cwm_functional %>% 
  filter(functional_group == "forb") %>% 
  mutate(sqrt_la = sqrt(weighted_la))

shrub <- cwm_functional %>% 
  filter(functional_group == "shrub")
  
```

#### CWMs with interaction between climate, treatment, and functional group

##### leaf area
```{r}
#leaf area is very skewed:
ggplot(cwm_functional, aes(x = weighted_la)) +
  geom_histogram() +
  theme_bw()+
  facet_wrap(~functional_group)

# #trying glm
# funct_la <- glm(data = cwm_functional, weighted_la ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
# dredge(funct_la)
# 
# simulateResiduals(funct_la, plot= T) #does not pass dispersion test
# shapiro.test(residuals(funct_la)) #but residuals are normal
# 
# testDispersion(simulateResiduals(funct_la, plot= T)) # does not pass
# 
# #trying log transformation with gaussian
# cwm_functional <- cwm_functional %>% 
#   mutate(log_la = log(weighted_la))
# 
# ggplot(cwm_functional, aes(x = log_la)) +
#   geom_histogram() +
#   theme_bw()+
#   facet_wrap(~functional_group)
# 
# funct_la <- glm(data = cwm_functional, log_la ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
# dredge(funct_la)
# funct_la <- glm(data = cwm_functional, log_la ~ climate + treatment + functional_group + climate:functional_group + functional_group:treatment, family = gaussian, na.action = na.fail)
# 
# simulateResiduals(funct_la, plot= T) #looks good
# shapiro.test(residuals(funct_la)) # but residuals are not normal
# 
# # trying Gamma with log link on un-transformed
# funct_la <- glm(data = cwm_functional, weighted_la ~ climate * treatment * functional_group, family = Gamma(link = "log"), na.action = na.fail)
# dredge(funct_la)
# funct_la <- glm(data = cwm_functional, weighted_la ~ climate + treatment + functional_group + climate:functional_group + functional_group:treatment, family = Gamma(link = "log"), na.action = na.fail)
# 
# simulateResiduals(funct_la, plot= T) #does not pass dispersion test, but is very close!
# shapiro.test(residuals(funct_la)) #but residuals are normal

#trying log+1 with gaussian
cwm_functional <- cwm_functional %>% 
  mutate(log_plus_la = log(weighted_la + 1))

ggplot(cwm_functional, aes(x = log_plus_la)) +
  geom_histogram() +
  theme_bw()

funct_la <- glm(data = cwm_functional, log_plus_la ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_la)
funct_la <- glm(data = cwm_functional, log_plus_la ~ climate + treatment + functional_group + climate:functional_group + functional_group:treatment, family = gaussian, na.action = na.fail)

simulateResiduals(funct_la, plot= T) #good
shapiro.test(residuals(funct_la)) #residuals are normal

emmeans(funct_la, pairwise ~ climate | treatment | functional_group)
emmeans(funct_la, pairwise ~ treatment | functional_group)
emmeans(funct_la, pairwise ~ climate | functional_group)
emmeans(funct_la, pairwise ~ functional_group)

LA_funct_sig_pairs <- as.data.frame(pairs(emmeans(funct_la, ~ climate * treatment * functional_group))) %>%
  separate(contrast, c("A", "B"), sep = " - ") %>%
  separate(A, c("A_climate", "A_treatment", "A_functional_group"), sep = ",") %>%
  separate(B, c("B_climate", "B_treatment", "B_functional_group"), sep = ",") %>%
  filter((A_climate == B_climate & A_functional_group == B_functional_group) |
          (A_climate == B_climate & A_treatment == B_treatment) |
           (A_treatment == B_treatment & A_functional_group == B_functional_group))
LA_funct_sig_pairs

```
##### specific leaf area
```{r}
#leaf area is very skewed:
ggplot(cwm_functional, aes(x = weighted_sla)) +
  geom_histogram() +
  theme_bw()+
  facet_wrap(~functional_group)

cwm_functional <- cwm_functional %>% 
  mutate(log_sla = log(weighted_sla))

# funct_sla <- glm(data = cwm_functional, weighted_sla ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
# dredge(funct_sla)
# 
# simulateResiduals(funct_sla, plot= T) #does not pass dispersion test
# shapiro.test(residuals(funct_sla)) # not normal
# 
# # trying log transformation with gaussian
# funct_sla <- glm(data = cwm_functional, log_sla ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
# dredge(funct_sla)
# funct_sla <- glm(data = cwm_functional, log_sla ~ climate + functional_group + treatment + climate:functional_group, family = gaussian, na.action = na.fail)
# 
# simulateResiduals(funct_sla, plot= T) # good
# shapiro.test(residuals(funct_sla)) # not normal

# # trying Gamma with log link on un-transformed
# funct_sla <- glm(data = cwm_functional, weighted_sla ~ climate * treatment * functional_group, family = Gamma, na.action = na.fail)
# dredge(funct_sla)
# funct_sla <- glm(data = cwm_functional, weighted_sla ~ climate + functional_group + treatment + climate:functional_group, family = Gamma, na.action = na.fail)
# 
# simulateResiduals(funct_sla, plot= T) # not normal
# shapiro.test(residuals(funct_sla)) # not normal

#trying log+1 with gaussian
cwm_functional <- cwm_functional %>% 
  mutate(log_plus_sla = log(weighted_sla + 1))

funct_sla <- glm(data = cwm_functional, log_plus_sla ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_sla)
funct_sla <- glm(data = cwm_functional, log_plus_sla ~ climate + functional_group + treatment + climate:functional_group, family = gaussian, na.action = na.fail)

simulateResiduals(funct_sla, plot= T) #good
shapiro.test(residuals(funct_sla)) #normal

emmeans(funct_sla, pairwise ~ climate | treatment | functional_group)
emmeans(funct_sla, pairwise ~ treatment | functional_group)
emmeans(funct_sla, pairwise ~ functional_group)

```
##### ldmc
```{r}
cwm_functional <- cwm_functional %>% 
  mutate(log_ldmc = log(weighted_ldmc))

funct_ldmc <- glm(data = cwm_functional, weighted_ldmc ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_ldmc)
funct_ldmc <- glm(data = cwm_functional, weighted_ldmc ~ climate + functional_group + treatment + climate:functional_group + functional_group:treatment, na.action = na.fail)

simulateResiduals(funct_ldmc, plot= T) # does not pass dispersion test
shapiro.test(residuals(funct_ldmc)) # not normal

# log transformation
funct_ldmc <- glm(data = cwm_functional, log_ldmc ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_ldmc)
funct_ldmc <- glm(data = cwm_functional, log_ldmc ~ climate + functional_group + treatment + climate:functional_group + functional_group:treatment, na.action = na.fail)

simulateResiduals(funct_ldmc, plot= T) # ok
shapiro.test(residuals(funct_ldmc)) # normal

emmeans(funct_ldmc, pairwise ~ climate | treatment | functional_group)
emmeans(funct_ldmc, pairwise ~ treatment | functional_group)
emmeans(funct_ldmc, pairwise ~ functional_group)
```
##### lnc
```{r}
funct_n <- glm(data = cwm_functional, weighted_n ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_n)
funct_n <- glm(data = cwm_functional, weighted_n ~ climate + functional_group + treatment + climate:functional_group + functional_group:treatment, na.action = na.fail)

simulateResiduals(funct_n, plot= T) # not good
shapiro.test(residuals(funct_n)) # not normal

cwm_functional <- cwm_functional %>% 
  mutate(log_n = log(weighted_n)) %>% 
  mutate(log_plus_n = log(weighted_n+1))

# trying log transformation with gaussian
funct_n <- glm(data = cwm_functional, log_n ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_n)
funct_n <- glm(data = cwm_functional, log_n ~ climate + functional_group + treatment + climate:functional_group, na.action = na.fail)

simulateResiduals(funct_n, plot= T) # looks ok
shapiro.test(residuals(funct_n)) # not normal

# trying log(n+1) transformation with gaussian
funct_n <- glm(data = cwm_functional, log_plus_n ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_n)
funct_n <- glm(data = cwm_functional, log_plus_n ~ climate + functional_group + treatment + climate:functional_group, na.action = na.fail)

simulateResiduals(funct_n, plot= T) # looks ok
shapiro.test(residuals(funct_n)) # normal

emmeans(funct_n, pairwise ~ climate | treatment | functional_group)
emmeans(funct_n, pairwise ~ treatment | functional_group)
emmeans(funct_n, pairwise ~ functional_group)

```
##### seed mass
```{r}
# # untransformed with gaussian
# funct_seed_mass <- glm(data = cwm_functional, weighted_seed_mass ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
# dredge(funct_seed_mass)
# funct_seed_mass <- glm(data = cwm_functional, weighted_seed_mass ~ climate + functional_group + treatment + climate:functional_group, na.action = na.fail)
# 
# simulateResiduals(funct_seed_mass, plot= T) # bad
# shapiro.test(residuals(funct_seed_mass)) # not normal

# log transformation with gaussian
cwm_functional <- cwm_functional %>% 
  mutate(log_seed_mass = log(weighted_seed_mass))

funct_seed_mass <- glm(data = cwm_functional, log_seed_mass ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_seed_mass)
funct_seed_mass <- glm(data = cwm_functional,log_seed_mass ~ climate + functional_group + climate:functional_group, na.action = na.fail)

simulateResiduals(funct_seed_mass, plot= T) # ok
shapiro.test(residuals(funct_seed_mass)) # normal

# for back transformation

funct_seed_mass <- glm(data = cwm_functional, log(weighted_seed_mass) ~ climate + functional_group + climate:functional_group, na.action = na.fail)
emmeans::contrast(funct_seed_mass)

funct_seed_mass_emm <- emmeans(funct_seed_mass, ~ climate + functional_group + climate:functional_group)
summary(funct_seed_mass_emm) # results are given on a log scale
summary(funct_seed_mass_emm, infer = TRUE, null = log(35), type = "response")

emmeans(funct_seed_mass, ~ climate)
test_emm <- emmeans(funct_seed_mass, "climate", transform = "log", type = "response")

funct_seed_mass.rg <- update(ref_grid(funct_seed_mass), tran = make.tran("genlog", 1))

contrast(regrid(funct_seed_mass.rg))
contrast(funct_seed_mass_emm)
contrast(test_emm)

emmeans(funct_seed_mass.rg, pairwise ~ climate | functional_group)
emmeans(funct_seed_mass, pairwise ~ climate | functional_group)
emmeans(funct_seed_mass, pairwise ~ climate | functional_group)
emmeans(funct_seed_mass, pairwise ~ functional_group)

```
##### Best-Fit Model Table
```{r}
dredge_funct_la <- as.data.frame(dredge(funct_la)) %>%
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Leaf Area (log(x+1))") %>% 
  dplyr::select(CWM, climate, functional_group, treatment, "climate:functional_group","climate:treatment", "functional_group:treatment", "climate:functional_group")

dredge_funct_sla <-  as.data.frame(dredge(funct_sla)) %>% 
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Specific Leaf Area (log(x+1)") %>% 
  dplyr::select(CWM, climate, functional_group, treatment, "climate:functional_group")

dredge_funct_ldmc <- as.data.frame(dredge(funct_ldmc)) %>% 
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Leaf Dry Matter Content (log)") %>% 
  dplyr::select(CWM, climate, functional_group, treatment, "climate:functional_group", "functional_group:treatment")

dredge_funct_seed_mass <- as.data.frame(dredge(funct_seed_mass)) %>% 
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Seed Mass (log)") %>% 
  dplyr::select(CWM, climate, functional_group, "climate:functional_group")

dredge_funct_n <- as.data.frame(dredge(funct_n)) %>% 
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Leaf Nitrogen Content (log(x+1)") %>% 
  dplyr::select(CWM, climate, functional_group, treatment, "climate:functional_group")

dredge_table <- dredge_funct_la %>% 
  full_join(dredge_funct_sla) %>% 
  full_join(dredge_funct_ldmc) %>% 
  full_join(dredge_funct_seed_mass) %>% 
  full_join(dredge_funct_n) %>% 
  mutate(climate = str_replace(climate, "\\+","x")) %>%
  mutate(functional_group = str_replace(functional_group, "\\+","x")) %>%
  mutate(treatment = str_replace(treatment, "\\+","x")) %>% 
  mutate(`climate:functional_group` = str_replace(`climate:functional_group`, "\\+","x")) %>%
  mutate(`climate:treatment` = str_replace(`climate:treatment`, "\\+","x")) %>% 
  mutate(`functional_group:treatment` = str_replace(`functional_group:treatment`, "\\+","x")) %>% 
  mutate(`climate:functional_group` = str_replace(`climate:functional_group`, "\\+","x"))

# Trying gt package
# data must be a tibble

pretty_table <- dredge_table %>% 
  as_tibble() %>% 
  gt() %>% 
  tab_header(
    title = "Functional Group CWM Best-Fit Models"
  ) %>% 
  tab_spanner(
    label = "Fixed Effects Terms",
    columns = vars(climate, functional_group, treatment, "climate:functional_group","climate:treatment", "functional_group:treatment", "climate:functional_group")
  ) %>% 
  fmt_missing(
    columns = vars(climate, functional_group, treatment, "climate:functional_group","climate:treatment", "functional_group:treatment", "climate:functional_group"),
    missing_text = " "
  ) %>% 
  tab_source_note(
    source_note = "x indicates selection of fixed effect term for best-fit model"
  )

# pretty_table

gtsave(data = pretty_table, filename = "Funct_Group_best_fit_table.png", path = "~/github/Tejon_Functional_Traits/Figures")
```
##### EMM Graphs
```{r}
# color of arrows
arrow_colors <- (rep(c("red", "orange", "blue"), 9))
# arrow_colors <- (rep(c("red", "red", "red", "orange", "orange", "orange", "blue", "blue", "blue"), 3))

funct_emm_plot <- function(emmeans) {
  plot(emmeans, type = "response", by = NULL, CIs = FALSE, comparisons = TRUE, horizontal = FALSE, colors = "black") +
    # geom_segment(aes_(y = ~the.emmean, yend = ~lcmpl, x = ~pri.fac, xend = ~pri.fac), 
    #            arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
    #            color ="black") +
    # geom_segment(ggplot2::aes_(y = ~the.emmean, yend = ~rcmpl, x = ~pri.fac, xend = ~pri.fac),
    #            arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
    #            color = "black") +
    # geom_point(aes_(fill = "black")) +
    theme(legend.position = "none")
}

# The geom_segment() code to change the color of the arrows (by just adding in different arrows over the top) does not work this way becasue some of the arrows do not overlap the points

```
###### Seed Mass
```{r}
# method 1 for plotting back transformation: 
# re-writing with the transformation in the model
funct_seed_mass <- glm(data = cwm_functional, log(weighted_seed_mass) ~ climate + functional_group + climate:functional_group, na.action = na.fail)

# use emmeans()
funct_seed_mass_emm <- emmeans(funct_seed_mass, ~ climate * functional_group)


# then plot with type = "response"

seed_mass_plot_1 <- funct_emm_plot(funct_seed_mass_emm)+
  facet_grid(. ~ functional_group, scales = "free", space = "free") +
  scale_x_discrete(labels = rep(c("Arid", "Intermediate", "Mesic"), 9)) +
  labs(title = "Seed Mass CWM by Functional Group", y = "Seed Mass (mg)", x = "Climate")

# method 2 for plotting back transformation:
# this uses the model that used the already transformed data
funct_seed_mass <- glm(data = cwm_functional, log_seed_mass ~ climate + functional_group + climate:functional_group, na.action = na.fail)

# updating with transformation information
funct_seed_mass.rg <- update(ref_grid(funct_seed_mass), tran = "log")

# plot
seed_mass_plot_2 <- funct_emm_plot(funct_seed_mass.rg)+
  facet_grid(. ~ functional_group, scales = "free", space = "free") +
  scale_x_discrete(labels = rep(c("Arid", "Intermediate", "Mesic"), 9)) +
  labs(title = "Seed Mass CWM by Functional Group", y = "Seed Mass (mg)", x = "Climate")

seed_mass_plot_1
seed_mass_plot_2

# ggsave("funct_seed_mass_plot.png", path = "~/github/Tejon_Functional_Traits/Figures", width = 10, height = 7, bg = "transparent")
```
###### Specific Leaf Area
```{r}
# log(x+1) transformation
# funct_sla <- glm(data = cwm_functional, log_plus_sla ~ climate + functional_group + treatment + climate:functional_group, family = gaussian, na.action = na.fail)

funct_sla <- glm(data = cwm_functional, log(weighted_sla + 1) ~ climate + functional_group + treatment + climate:functional_group, family = gaussian, na.action = na.fail)

funct_sla_emm <- emmeans(funct_sla, ~ climate + functional_group + treatment + climate:functional_group)

emmeans(funct_sla, pairwise ~ climate + functional_group + treatment + climate:functional_group)

# plot

funct_emm_plot(funct_sla_emm) +
  facet_grid(. ~ functional_group + climate, scales = "free", space = "free") +
  aes(fill = as.factor(treatment)) +
  scale_x_discrete(labels = rep(c("Open", "Partial", "Total"), 9)) +
  labs(title = "Specific Leaf Area CWM by Functional Group", x = "Treatment") +
  theme(panel.margin = unit(0, "lines"),
        panel.border = element_rect(color = "black", fill = NA, size = 0.5),
        panel.background = element_rect(fill = c("#E2F0D9", "#DEEBF7")))


plot(funct_sla_emm, type = "response", by = NULL, CIs = FALSE, comparisons = TRUE, horizontal = FALSE, colors = "black") +
    facet_grid(. ~ functional_group + climate, scales = "free", space = "free") +
    aes(fill = as.factor(treatment)) +
    scale_x_discrete(labels = rep(c("Open", "Partial", "Total"), 9)) +
    labs(title = "Specific Leaf Area CWM by Functional Group", x = "Treatment") +
    # theme(panel.margin = unit(0, "lines"),
    #     panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    #     strip.background.x = element_rect(fill = c("#E2F0D9", "#DEEBF7")),
    #     strip.text.x = element_blank()
    #     ) + 
    theme(legend.position = "none")
  
plot(funct_sla_emm, by = NULL, CIs = FALSE, comparisons = TRUE, horizontal = FALSE, colors = "black") +
  facet_grid(. ~ functional_group + climate, scales = "free", space = "free", 
             labeller = label_wrap_gen(multi_line=FALSE))

plot(funct_sla_emm, by = NULL, CIs = FALSE, comparisons = TRUE, horizontal = FALSE, colors = "black") +
  facet_grid(. ~ functional_group + climate, scales = "free", space = "free", 
             labeller = label_wrap_gen(multi_line=FALSE),
             labeller = as_labeller(c(
               'forb, Arid' = "Forb", 'forb, Intermediate' = "Forb", 'Forb, Meisc' = "Forb", 
               'grass, Arid' = "grass", 'grass, Intermediate' = "grass", 'grass, Meisc' = "shrub", 
               'shrub, Arid' = "shrub", 'shrub, Intermediate' = "shrub", 'shrub, Meisc' = "shrub")))

emmeans(funct_sla, pairwise ~ treatment)


```
###### Leaf Area
```{r}
funct_la_emm <- emmeans(funct_la, pairwise ~ treatment + climate + functional_group)

# emmeans(funct_la, pairwise ~ treatment | climate | functional_group)

funct_la_plot <- plot(la_emmeans, by = NULL, CIs = FALSE, comparisons = TRUE, horizontal = FALSE, colors = "darkgreen") +
  facet_grid(. ~ functional_group + climate, scales = "free", space = "free") +
  aes(fill = as.factor(treatment)) +
   geom_segment(aes_(y = ~the.emmean, yend = ~lcmpl, x = ~pri.fac, xend = ~pri.fac), #copied from function's code on github
               arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
               color ="black") +
  geom_segment(ggplot2::aes_(y = ~the.emmean, yend = ~rcmpl, x = ~pri.fac, xend = ~pri.fac),
               arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
               color = "black") +
  geom_point(aes_(fill = "black")) +
  # theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  scale_x_discrete(labels = rep(c("Open", "Partial", "Total"), 9)) +
  labs(title = "Leaf Area CWM by Functional Group") +
    theme(legend.position = "none")

funct_la_plot 

ggsave("funct_la_plot.png", path = "~/github/Tejon_Functional_Traits/Figures", width = 10, height = 7, bg = "transparent")


```

#### ggeffects Graphs
```{r}
ggeffects_colors <- c("#f46d43", "#fee090", "#74add1")

funct_la_plot <- plot(ggpredict(funct_la, terms = c("treatment", "climate", "functional_group")), colors = ggeffects_colors, facet = TRUE)
funct_sla_plot <- plot(ggpredict(funct_sla, terms = c("treatment", "climate", "functional_group")), colors = ggeffects_colors,facet = TRUE)
funct_ldmc_plot <- plot(ggpredict(funct_ldmc, terms = c("treatment", "climate", "functional_group")), colors = ggeffects_colors,facet = TRUE)
funct_n_plot <- plot(ggpredict(funct_n, terms = c("treatment", "climate", "functional_group")), colors = ggeffects_colors,facet = TRUE)
funct_seed_mass_plot <- plot(ggpredict(funct_seed_mass, terms = c("climate", "functional_group")), colors = ggeffects_colors,facet = TRUE)

funct_group_CWM_emmeans <- grid.arrange(funct_la_plot, funct_sla_plot, funct_ldmc_plot, funct_n_plot, funct_seed_mass_plot)

ggsave("funct_group_CWM_emmeans.png", plot = funct_group_CWM_emmeans, path = "~/github/Tejon_Functional_Traits/Figures/ggeffects_graphs", height = 7, width = 10)

```

#### using sjPlot
```{r}
library(sjPlot)

plot_model(funct_la, type = "emm", terms = c("climate", "treatment", "functional_group"))

plot_model(funct_sla, type = "emm", terms = c("climate", "treatment", "functional_group"))
```
#### Individual Models:
#### a. grasses:
##### i. leaf area
```{r}
grass_la <- glm(data = grass, weighted_la ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_la) # best model: trait ~ climate * treatment

simulateResiduals(grass_la, plot= T) #good
shapiro.test(residuals(grass_la)) #normal

summary(grass_la)
emmeans(grass_la, pairwise ~ climate)
emmeans(grass_la, pairwise ~ treatment | climate)
```
##### ii. specific leaf area
```{r}
grass_sla <- glm(data = grass, weighted_sla ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_sla) # best model: trait ~ climate * treatment

simulateResiduals(grass_sla, plot= T) # good
shapiro.test(residuals(grass_sla)) # normal

summary(grass_sla)
emmeans(grass_sla, pairwise ~ climate)
emmeans(grass_sla, pairwise ~ treatment | climate)
```
##### iii.ldmc
```{r}
grass_ldmc <- glm(data = grass, weighted_ldmc ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_ldmc) # best model: trait ~ climate + treatment
grass_ldmc <- glm(data = grass, weighted_ldmc ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(grass_ldmc, plot= T) # not good
shapiro.test(residuals(grass_ldmc)) # not normal

grass <- grass %>% 
  mutate(log_ldmc = log(weighted_ldmc))

grass_ldmc <- glm(data = grass, log_ldmc ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_ldmc) # best model: trait ~ climate
grass_ldmc <- glm(data = grass, log_ldmc ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(grass_ldmc, plot= T) # good
shapiro.test(residuals(grass_ldmc)) # normal

summary(grass_ldmc)
emmeans(grass_ldmc, pairwise ~ climate)
```
##### iv. lnc
```{r}
grass_n <- glm(data = grass, weighted_n ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_n) # best model: trait ~ climate
grass_n <- glm(data = grass, weighted_n ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(grass_n, plot= T) # good
shapiro.test(residuals(grass_n)) # normal

summary(grass_n)
emmeans(grass_n, pairwise ~ climate)
```
##### v. seed mass
```{r}
grass_seed_mass <- glm(data = grass, weighted_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
boxcox(grass_seed_mass) # might be best to do ln transformation
dredge(grass_seed_mass) # best model: trait ~ climate + treatment
grass_seed_mass <- glm(data = grass, weighted_seed_mass ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # not good
shapiro.test(residuals(grass_seed_mass)) # normal

grass <- grass %>% 
  mutate(log_seed_mass = log(weighted_seed_mass)) %>% 
  mutate(ln_seed_mass = log10(weighted_seed_mass)) %>% 
  mutate(sqrt_seed_mass = sqrt(weighted_seed_mass))

grass_seed_mass <- glm(data = grass, log_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_seed_mass) # best model: trait ~ climate
grass_seed_mass <- glm(data = grass, log_seed_mass ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # ok?
shapiro.test(residuals(grass_seed_mass)) # not normal

grass_seed_mass <- glm(data = grass, ln_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_seed_mass) # best model: trait ~ climate
grass_seed_mass <- glm(data = grass, ln_seed_mass ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # ok?
shapiro.test(residuals(grass_seed_mass)) # not normal

grass_seed_mass <- glm(data = grass, sqrt_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_seed_mass) # best model: trait ~ climate + treatment
grass_seed_mass <- glm(data = grass, sqrt_seed_mass ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # not ok
shapiro.test(residuals(grass_seed_mass)) # normal

# gamma distribution worked all along
grass_seed_mass <- glm(data = grass, weighted_seed_mass ~ climate * treatment, family = Gamma, na.action = na.fail)
dredge(grass_seed_mass) # best model: trait ~ climate + treatment
grass_seed_mass <- glm(data = grass, weighted_seed_mass ~ climate + treatment, family = Gamma, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # good
shapiro.test(residuals(grass_seed_mass)) # normal

summary(grass_seed_mass)
emmeans(grass_seed_mass, pairwise ~ climate)
emmeans(grass_seed_mass, pairwise ~ treatment | climate)
```
#### b. forbs
##### i. la
```{r}
forb_la <- glm(data = forb, log_la ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_la) # best model is climate + treatment
forb_la <- glm(data = forb, log_la ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(forb_la, plot= T) # ok
shapiro.test(residuals(forb_la)) #normal

summary(forb_la)
emmeans(forb_la, pairwise ~ climate)
emmeans(forb_la, pairwise ~ treatment | climate)
```
##### ii. sla
```{r}
forb_sla <- glm(data = forb, weighted_sla ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_sla) # best model is only climate
forb_sla <- glm(data = forb, weighted_sla ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(forb_sla, plot= T) # ok
shapiro.test(residuals(forb_sla)) # not normal

forb_sla <- glm(data = forb, weighted_sla ~ climate * treatment, family = Gamma, na.action = na.fail)
dredge(forb_sla) # best model: trait ~ climate
forb_sla <- glm(data = forb, weighted_sla ~ climate, family = Gamma, na.action = na.fail)

simulateResiduals(forb_sla, plot= T) # ok
shapiro.test(residuals(forb_sla)) # normal

summary(forb_sla)
emmeans(forb_sla, pairwise ~ climate)
```
##### iii. ldmc
```{r}
forb_ldmc <- glm(data = forb, weighted_ldmc ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_ldmc) # best model: trait ~ treatment
forb_ldmc <- glm(data = forb, weighted_ldmc ~ treatment, family = gaussian, na.action = na.fail)

simulateResiduals(forb_ldmc, plot= T) # ok
shapiro.test(residuals(forb_ldmc)) # normal

summary(forb_ldmc)
emmeans(forb_ldmc, pairwise ~ treatment)
```
##### iv.lnc
```{r}
forb_leaf_n <- glm(data = forb, weighted_n ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_leaf_n) # best model: trait ~ climate
forb_leaf_n <- glm(data = forb, weighted_n ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(forb_leaf_n, plot= T) # ok
shapiro.test(residuals(forb_leaf_n)) # normal

summary(forb_leaf_n)
emmeans(forb_leaf_n, pairwise ~ climate)
```
##### v.seed mass
```{r}
forb_seed_mass <- glm(data = forb, weighted_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_seed_mass) # best model: trait ~ climate * treatment

simulateResiduals(forb_seed_mass, plot= T) # not good
shapiro.test(residuals(forb_seed_mass)) # not normal

forb_seed_mass <- glm(data = forb, weighted_seed_mass ~ climate * treatment, family = Gamma, na.action = na.fail)
dredge(forb_seed_mass) # best model: trait ~ climate * treatment

simulateResiduals(forb_seed_mass, plot= T) # ok
shapiro.test(residuals(forb_seed_mass)) # not normal

forb <- forb %>% 
  mutate(log_seed_mass = log(weighted_seed_mass))

forb_seed_mass <- glm(data = forb, log_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_seed_mass) # best model: trait ~ climate
forb_seed_mass <- glm(data = forb, log_seed_mass ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(forb_seed_mass, plot= T) # ok
shapiro.test(residuals(forb_seed_mass)) # normal

summary(forb_seed_mass)
emmeans(forb_seed_mass, pairwise ~ climate)
```
#### c. shrubs
##### i.la
- what do you do when residuals are normal but the residual vs. predicted plot looks terrible?
```{r}
shrub_la <- glm(data = shrub, weighted_la ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_la) # best model: trait ~ climate + treatment
shrub_la  <- glm(data = shrub, weighted_la ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_la, plot= T) # very bad
shapiro.test(residuals(shrub_la)) # normal

summary(shrub_la)
emmeans(shrub_la, pairwise ~ climate)
```
##### ii.sla
```{r}
shrub_sla <- glm(data = shrub, weighted_sla ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_sla) # best model: trait ~ 1
shrub_sla  <- glm(data = shrub, weighted_sla ~ 1, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_sla, plot= T) # fine
shapiro.test(residuals(shrub_sla)) # normal

```
##### iii.ldmc
```{r}
shrub_ldmc <- glm(data = shrub, weighted_ldmc ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_ldmc) # best model: trait ~ treatment; NEED TO DO MODEL AVERAGING
shrub_ldmc  <- glm(data = shrub, weighted_ldmc ~ treatment, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_ldmc, plot= T) # fine
shapiro.test(residuals(shrub_ldmc)) # normal

summary(shrub_ldmc)
emmeans(shrub_ldmc, pairwise ~ treatment)
```
##### iv.lnc
```{r}
shrub_n <- glm(data = shrub, weighted_n ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_n) # NEED TO DO MODEL AVERAGING
shrub_n  <- glm(data = shrub, weighted_n ~ treatment, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_n, plot= T) # fine
shapiro.test(residuals(shrub_n)) # normal

summary(shrub_n)
emmeans(shrub_n, pairwise ~ treatment)
```
##### v.seed mass
```{r}
shrub_seed_mass <- glm(data = shrub, weighted_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_seed_mass) # NEED TO DO MODEL AVERAGING
shrub_seed_mass  <- glm(data = shrub, weighted_seed_mass ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_seed_mass, plot= T) # bad
shapiro.test(residuals(shrub_seed_mass)) # normal

summary(shrub_n)
emmeans(shrub_n, pairwise ~ treatment)

```
