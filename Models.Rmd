---
title: "Untitled"
author: "Maggie Klope"
date: "10/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(stats)
library(sjPlot)
library(FD)
library(DHARMa) #model diagnostics
library(glmmTMB) #model fitting
library(MuMIn) #model summaries and comparisons
library(emmeans) #post-hoc analyses

# Loading 2019 abundance data calculated from transect surveys
abund_2019 <-  read_csv("Datasheets/2019_abundance_sci_names.csv") %>% 
  rename(species_name = Species) %>% #changing column names
  rename(climate = Climate) %>% #changing column names
  rename(treatment = Plot)#changing column names

abund_2019$climate[abund_2019$climate == "Int"] <- "Intermediate" #changing name of int climate

# Loading 2019 functional trait data (currently only has LA)
traits_19 <- read_csv("Datasheets/temp_2019_traits.csv") %>% 
  rename(old_names = Species) %>% #changing column names
  rename(Species = sci_name) %>% #changing column names
  select(Climate, Treatment, Block, Species, LA) %>% 
  mutate(LA = as.numeric(LA)) #making sure value is numeric

abund_2019$climate[abund_2019$climate == "Int"] <- "Intermediate"#changing name of int climate

# Loading 2017 functional trait data
# traits_17 <- read_csv("final_traits_and_abundances.csv")

# TRY Database search to fill in missing species
TRY_DB <- read_csv("Datasheets/TRY_DB_june_2020.csv") %>% 
  filter(ValueKindName == c("Single", "Mean", "Best estimate")) %>% 
  #unique() %>% 
  dplyr::group_by(TraitName, AccSpeciesName) %>%
  summarize(mean_value = mean(StdValue)) %>% 
  rename(species_name = AccSpeciesName)

# write_csv(TRY_DB, "TRY_DB_summary.csv")

# reading in 2017 functional trait datasheet
md <- read_csv("Datasheets/MasterDataSheet(9_29_2020).csv") %>% 
  select(climate, treatment, species_name, individual, wet_weight_g, wet_weight_mg, dry_weight_g, dry_weight_mg, Area_Leaf_total_mm2, Average_Leaf_Area, average_dry_weight, average_wet_weight) %>% 
  mutate(wet_weight_mg = as.numeric(wet_weight_mg)) %>% 
  mutate(wet_weight_g = as.numeric(wet_weight_g)) %>% 
  mutate(dry_weight_g = as.numeric(dry_weight_g)) %>% 
  mutate(dry_weight_mg = as.numeric(dry_weight_mg)) %>% 
  mutate(leaf_area = as.numeric(Average_Leaf_Area)) %>% 
  mutate(sla = Area_Leaf_total_mm2 / dry_weight_mg) %>% #computing sla
  mutate(ldmc = dry_weight_mg / wet_weight_g) %>% #computing ldmc
  select(-average_wet_weight, -average_dry_weight)
  #drop_na(leaf_area) %>% 
  #filter(leaf_area != 0)

#finding average values for 2017 from the masterdatasheet
traits_2017 <- md %>% 
  group_by(climate, treatment, species_name) %>% 
  summarise_all(mean, na.rm = TRUE)
#changing treatment names
traits_2017$treatment[traits_2017$treatment == "Cattle Exclosure"] <- "Partial"
traits_2017$treatment[traits_2017$treatment == "Control"] <- "Open"
traits_2017$treatment[traits_2017$treatment == "Full Exclosure"] <- "Total"
# changing climate names
traits_2017$climate[traits_2017$climate == "Semi-arid"] <- "Intermediate"

#need to rename some species to match 2019 abundance
traits_2017$species_name[traits_2017$species_name == "Trifolium microcephalum"] <- "Trifolium sp."
traits_2017$species_name[traits_2017$species_name == "lupinus bicolor?"] <- "Lupinus bicolor"
traits_2017$species_name[traits_2017$species_name == "Erodium cicutarium"] <- "Erodium sp."
traits_2017$species_name[traits_2017$species_name == "Erodium brachycarpum"] <- "Erodium sp."
traits_2017$species_name[traits_2017$species_name == "Ribes sp."] <- "Ribes californicum var. hesperium"
traits_2017$species_name[traits_2017$species_name == "Melica imperfecta"] <- "Melica californica"
traits_2017$species_name[traits_2017$species_name == "Plagiobothrys nothofulvus"] <- "Plagiobothrys sp."

#combining 2017 trait data with 2019 abundance data
cwm_traits <- abund_2019 %>% 
  group_by(climate, treatment) %>% 
  left_join(traits_2017, by = c("climate", "treatment", "species_name")) %>% 
  select(climate, treatment, Block, species_name, Abundance, leaf_area, sla, ldmc, Notes)

other_traits <- read_csv("Datasheets/seed_mass_leaf_N.csv")

#data (updated) for Community-weighted means (CWMs)
cwm_traits_adj <-  read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  mutate(weighted_la = leaf_area * Abundance) %>% #multiplying trait values by species abundance
  mutate(weighted_sla = sla * Abundance) %>% 
  mutate(weighted_ldmc = ldmc * Abundance) %>%
  mutate(weighted_seed_mass = seed_mass * Abundance) %>%
  mutate(weighted_n = leaf_n * Abundance) %>%
  group_by(climate, treatment, Block) %>% #grouping by climate, treatment, and block
  summarise_all(mean, na.rm = TRUE) %>% #finding the mean
  select(climate, treatment, Block, weighted_la, weighted_sla, weighted_ldmc, weighted_seed_mass, weighted_n)

#making a df just for functional diveristy calculations
for_FD <- cwm_traits <-  read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  select(climate, treatment, Block, species_name, Abundance, leaf_area, sla, ldmc, seed_mass, leaf_n)
```

## Data exploration

```{r}


```


## GLMs for individual species change

- Does not include block because I only have the mean for each species at each plot
- Some species are present in all climate/treatment, but some are not
- Some species could be done with an lm after a log transformation

```{r}
#Bromus diandrus (grass)
glm_bro_dia <- glm(data = traits_19[traits_19$Species == "Bromus diandrus",], LA ~ Climate * Treatment, family = gaussian)

# Festuca myuros (grass)
glm_fes_myu <- glm(data = traits_19[traits_19$Species == "Festuca myuros",], LA ~ Climate * Treatment,  family = gaussian)

# Bromus hordeacous (grass)
glm_bro_ho <- glm(data = traits_19[traits_19$Species == "Bromus hordeaceus",], LA ~ Climate * Treatment, family = gaussian)

# Bromus tectorum (grass)
glm_bro_tec <- glm(data = traits_19[traits_19$Species == "Bromus tectorum",], LA ~ Climate * Treatment, family = gaussian)

# Hordeum murinum (grass)
glm_hor_mur <- glm(data = traits_19[traits_19$Species == "Hordeum murinum",], LA ~ Climate * Treatment, family = gaussian)

# Erodium cicutarium (forb)
glm_ero_cic <- glm(data = traits_19[traits_19$Species == "Erodium cicutarium",], LA ~ Climate * Treatment, family = gaussian)

# Galium aparine (forb)
glm_gal_apa <- glm(data = traits_19[traits_19$Species == "Galium aparine",], LA ~ Climate * Treatment, family = gaussian)

# Plagiobothrys nothofulvus (forb)
glm_pla_not <- glm(data = traits_19[traits_19$Species == "Plagiobothrys nothofulvus",], LA ~ Climate * Treatment, family = gaussian)

# Ribes californicum var. hesperium (shrub)
glm_ribes <- glm(data = traits_19[traits_19$Species == "Ribes californicum var. hesperium",], LA ~ Climate * Treatment, family = gaussian)

# Symphoricarpos_mollis (shrub)
glm_sym_mol <- glm(data = traits_19[traits_19$Species == "Symphoricarpos_mollis",], LA ~ Treatment, family = gaussian) #only at Mesic climate

# Ericameria nauseosa (shrub)
glm_eri_nau <- glm(data = traits_19[traits_19$Species == "Ericameria nauseosa",], LA ~ Climate * Treatment, family = gaussian)
```

## GLMs for Community-weighted means (CWMs)

- Calculated with 2017 trait data
- again, one value per climate/treatment/block so no blocking effect included
- Include interaction between climate and treatment? AIC values for some are much higher without interaction

1) Model:

**What is the effect of climate and grazing community-weighted means?**

`lm(LA ~ Climate * Treatment, family = gaussian)`

```{r}

cwm_traits_adj %>%
  pivot_longer(cols = weighted_la:weighted_n,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_wrap(~traits, scales = "free")

```

```{r}
ggplot(cwm_traits_adj, aes(x = weighted_la)) +
  geom_histogram() +
  theme_bw()

ggplot(cwm_traits_adj, aes(x = weighted_sla)) +
  geom_histogram() +
  theme_bw()

ggplot(cwm_traits_adj, aes(x = weighted_ldmc)) +
  geom_histogram() +
  theme_bw()

ggplot(cwm_traits_adj, aes(x = weighted_seed_mass)) +
  geom_histogram() +
  theme_bw()

ggplot(cwm_traits_adj, aes(x = weighted_n)) +
  geom_histogram() +
  theme_bw()

#trying log transformation for seed mass & leaf n
cwm_traits_adj <- cwm_traits_adj %>% 
  mutate(log_seed_mass = log(weighted_seed_mass)) %>% 
  mutate(log_n = log(weighted_n))


```


2) Best-fit model:

```{r}
# leaf area
LA_CWM <- glmmTMB(data = cwm_traits_adj, weighted_la ~ climate * treatment, family = gaussian)
dredge(LA_CWM) #best model: weighted_la ~ climate * treatment

#SLA
SLA_CWM <- glmmTMB(data = cwm_traits_adj, weighted_sla ~ climate * treatment, family = gaussian) 
dredge(SLA_CWM) #best model: weighted_sla ~ climate * treatment

# LDMC
LDMC_CWM <- glmmTMB(data = cwm_traits_adj, weighted_ldmc ~ climate * treatment, family = gaussian) 
dredge(LDMC_CWM) #best model: weighted_ldmc ~ climate + treatment
LDMC_CWM <- glmmTMB(data = cwm_traits_adj, weighted_ldmc ~ climate + treatment, family = gaussian) 

# Seed mass
seed_mass_CWM <- glmmTMB(data = cwm_traits_adj, weighted_seed_mass ~ climate * treatment, family = gaussian) 
dredge(seed_mass_CWM) #best model: weighted_seed_mass ~ cliamte + treatment
seed_mass_CWM <- glmmTMB(data = cwm_traits_adj, weighted_seed_mass ~ climate + treatment, family = gaussian) 

#Log seed mass
log_seed_mass <- glmmTMB(data = cwm_traits_adj, log_seed_mass ~ climate * treatment, family = gaussian)
dredge(log_seed_mass) #best model: weighted_seed_mass ~ cliamte + treatment
log_seed_mass <- glmmTMB(data = cwm_traits_adj, log_seed_mass ~ climate + treatment, family = gaussian)

# leaf nitrogen
leaf_n_CWM <- glmmTMB(data = cwm_traits_adj, weighted_n ~ climate * treatment, family = gaussian) 
dredge(leaf_n_CWM) #best model: weighted_n ~ climate + treatment
leaf_n_CWM <- glmmTMB(data = cwm_traits_adj, weighted_n ~ climate + treatment, family = gaussian) 

# log leaf nitrogen
log_n_CWM <- glmmTMB(data = cwm_traits_adj, log_n ~ climate * treatment, family = gaussian) 
dredge(log_n_CWM) #get: Fixed terms are "cond((Int))" and "disp((Int))"
log_n_CWM <- glmmTMB(data = cwm_traits_adj, log_n ~ climate + treatment, family = gaussian) 
dredge(log_n_CWM)


# summary figure (some info missing because not present in all glms)
# tab_model(LA_CWM, SLA_CWM, LDMC_CWM, seed_mass_CWM, leaf_n_CWM, dv.labels = c("Leaf Area CWM", "SLA CWM", "LDMC CWM", "Seed Mass CWM", "LNC CWM"))


```

3) Model assumptions/data distribution

```{r}
simulateResiduals(LA_CWM, plot= T) #What is the red asterisk on the model predictions graph?

simulateResiduals(SLA_CWM, plot= T) #looks good

simulateResiduals(LDMC_CWM, plot= T) #looks good

simulateResiduals(seed_mass_CWM, plot= T) #model predictions look a little wonky, but it says it's good.  I'm also getting something saying that "outer Newton did not converge fully?

#log seed mass
simulateResiduals(log_seed_mass, plot= T) #looks good

simulateResiduals(leaf_n_CWM, plot= T) #is this good enough? one of the model predictions seems to be off

#log_n
simulateResiduals(log_n_CWM, plot= T) #looks good?


```

## Functional Diveristy
- Need to make datasheets in correct format for FD package

```{r}



```

