---
title: "CWM_Models"
author: "Maggie Klope"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(stats)
library(sjPlot)
library(FD)
library(DHARMa) #model diagnostics
library(glmmTMB) #model fitting
library(MuMIn) #model summaries and comparisons
library(emmeans) #post-hoc analyses
library(gt)
library(tibble)
library(lsmeans)
library(gridExtra)
library(multcomp)
library(car)

other_traits <- read_csv("Datasheets/seed_mass_leaf_N.csv")

cwm_traits_adj <-  read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  mutate(weighted_la = leaf_area * Abundance) %>% #multiplying trait values by species abundance
  mutate(weighted_sla = sla * Abundance) %>% 
  mutate(weighted_ldmc = ldmc * Abundance) %>%
  mutate(weighted_seed_mass = seed_mass * Abundance) %>%
  mutate(weighted_n = leaf_n * Abundance) %>%
  group_by(climate, treatment, Block) %>% #grouping by climate, treatment, and block
  summarise_all(mean, na.rm = TRUE) %>% #finding the mean
  select(climate, treatment, Block, weighted_la, weighted_sla, weighted_ldmc, weighted_seed_mass, weighted_n)

# log transformation for seed mass & leaf n
cwm_traits_adj <- cwm_traits_adj %>% 
  mutate(log_seed_mass = log(weighted_seed_mass)) %>% 
  mutate(log_n = log(weighted_n))

```

## GLMs for Community-weighted means (CWMs)

- Calculated with 2017 trait data
- again, one value per climate/treatment/block so no blocking effect included
- Include interaction between climate and treatment? AIC values for some are much higher without interaction

### Models:

**What is the effect of climate and grazing on community-weighted means?**

`lm(LA ~ Climate * Treatment, family = gaussian)`

```{r, include=FALSE}
cwm_bar_data <- cwm_traits_adj %>%
  pivot_longer(cols = weighted_la:weighted_n,
               names_to = "traits",
               values_to = "value")

ggplot(cwm_bar_data, aes(x = climate, y = value)) +
  geom_boxplot(aes(fill = treatment)) +
  theme_bw() +
  facet_wrap(~traits, scales = "free", nrow = 3) +
  scale_fill_manual(values = c("#ffffff", "#d9d9d9", "#969696"))

ggsave("CWM_barchart.png", path = "~/github/Tejon_Functional_Traits/Figures", width = 9, height = 7)

```

#### a. LA CWM

- Averaged over treatment, climate is different between Arid-Int and Arid-Mesic
- Averaged over climate, treatment is different between Open-Total and Partial-Total, but not Open-Partial
- Arid Total LA CWM larger than all other plots
- Arid:
    - Arid Total > Arid Open and Arid Partial
    - No difference between Arid Open and Arid Partial
- Intermediate:
    - No difference between herbivore treatments
- Mesic:
    - No difference between herbivore treatments
- Total herbivore treatment:
    - Arid Total larger than Intermediate Total and Mesic Total
    - No difference between Int Total and Mesic Total
- No differences between Open or Partial Treatments across climates


```{r}
# Best fit model:
LA_CWM <- glm(data = cwm_traits_adj, weighted_la ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(LA_CWM) #best model: weighted_la ~ climate * treatment

# Checking data
simulateResiduals(LA_CWM, plot= T) #What is the red asterisk on the model predictions graph?
shapiro.test(residuals(LA_CWM)) #normal

# pairwise comparisons
emmeans(LA_CWM, pairwise ~ climate)
emmeans(LA_CWM, pairwise ~ treatment)
# emmeans(LA_CWM, pairwise ~ climate * treatment)
emmeans(LA_CWM, pairwise ~ climate | treatment)
emmeans(LA_CWM, pairwise ~ treatment | climate)

test <- emmeans(LA_CWM, pairwise ~ climate | treatment)
emmeans::contrast(test)

View(as.data.frame(test$emmeans))
View(as.data.frame(test$contrasts))

#visualization
plot(emmeans(LA_CWM, ~ climate | treatment), comparisons = TRUE)

# data <- as.data.frame(test$emmeans) %>%
#   mutate(upper_limit = emmean +  SE) %>%
#   mutate(lower_limit = emmean -  SE)
# 
# ggplot(data, aes(x = climate, y = emmean)) +
#   geom_point()+
#   facet_wrap(data$treatment)+
# # geom_ribbon(aes(ymin = data$lower_limit, ymax = data$upper_limit), linetype=2, alpha=0.1)
# # geom_errorbar(aes(ymin = data$lower_limit, ymax = data$upper_limit)
#   geom_pointrange(aes(ymin = data$lower_limit, ymax = data$upper_limit))
#   

# plot(pairs(emmeans(LA_CWM, ~ climate | treatment)), comparisons = TRUE)

plot(emmeans(LA_CWM, ~ climate | treatment), 
     type = "response", 
     comparisons = TRUE, # If arrows overlap, they are not statistically significant
     colors = c("black", "black", "blue", "black")) + # color names for estimates, CIs, PIs, and comparison arrows, respectively
  # this is a ggplot so you can customize as normal
  theme_bw() +   
  labs(x = "Estimated marginal mean (LA CWM)", y = "Climate")

test_2 <- as.data.frame(pairs(emmeans(LA_CWM, ~ climate * treatment))) %>%
  separate(contrast, c("A", "B"), sep = " - ") %>%
  # select(A, B, estimate, p.value) %>%
  mutate(A = str_replace_all(A, "," , "-")) %>%
  mutate(B = str_replace_all(B, "," , "-")) %>%
  mutate(upper_limit = estimate +  SE) %>%
  mutate(lower_limit = estimate -  SE)

# trying to set own colors
# arrow_colors <- function(climates){
#   if (climates == "Arid") return({"red"})
#   if (climates == "Intermediate") return({"orange"})
#   if (climates == "Mesic") return({"blue"})
# }
# 
# arrow_colors <- function(input){
#   if (input == "Open") return({"red"})
#   if (input == "Partial") return({"orange"})
#   if (input == "Total") return({"blue"})
# }

plot(test, 
     type = "response",
     CI = FALSE,
     comparisons = TRUE, # If arrows overlap, they are not statistically significant
     colors = c("black", "black", "blue", "black")) + # color names for estimates, CIs, PIs, and comparison arrows, respectively
  # this is a ggplot so you can customize as normal
  theme_bw() +   
  labs(x = "Estimated marginal mean (LA CWM)", y = "Climate")

#Compact Letter Display
la_emm <- emmeans(LA_CWM, ~ climate)
la_cdf <- multcomp::cld(la_emm, alpha = 0.05, Letters = LETTERS)

```


```{r}
# double-checking against anova results
LA_aov <- aov(data = cwm_traits_adj, weighted_la ~ climate * treatment)

dredge(LA_aov)
simulateResiduals(LA_aov, plot = T)
shapiro.test(residuals(LA_aov))

summary(LA_aov)
tukey_LA <- TukeyHSD(LA_aov)
TukeyHSD(LA_aov)

# making a plot

plot(tukey_LA, ~ climate | treatment)

climate <- as.data.frame(tukey_LA$climate) %>% 
  rownames_to_column()

ggplot(climate, aes(x = rowname, y = diff)) + 
  geom_boxplot()

```


#### b. SLA CWM

- Once again, Arid Total larger than almost all other treatments
- Arid trends:
    - Arid Total larger than Arid Open and Arid Partial
    - No significant difference between Arid Total & Partial
- No different between Intermediate herbivore treatments
- No difference between Mesic herbivore treatments
- For Total exclosures, almost follows Arid > Int > Mesic
    - Arid Total > Mesic Total
    - Arid Total > Int total (almost significant, p=0.0546)
    - Int Total > Mesic Total
- Other significant difference:
    - Arid Open > Mesic Open

```{r}
# best fit model
SLA_CWM <- glm(data = cwm_traits_adj, weighted_sla ~ climate * treatment, family = gaussian, na.action = na.fail) 
dredge(SLA_CWM) #best model: weighted_sla ~ climate * treatment
#NEED TO DO MODEL AVERAGE

# testing data
simulateResiduals(SLA_CWM, plot= T) #looks good
shapiro.test(residuals(SLA_CWM)) #normal

SLA_sig_pairs <- as.data.frame(pairs(emmeans(SLA_CWM, ~climate * treatment)))%>% 
  filter(p.value <= 0.05)

emmeans(SLA_CWM, pairwise ~ climate)
emmeans(SLA_CWM, pairwise ~ treatment)
# emmeans(SLA_CWM, pairwise ~ climate * treatment)
emmeans(SLA_CWM, pairwise ~ treatment | climate)

plot(emmeans(SLA_CWM, pairwise ~ treatment | climate), comparisons = TRUE)

sla_emm <- emmeans(SLA_CWM, ~ climate)
multcomp::cld(sla_emm, alpha = 0.05, Letters = LETTERS)

```


#### c. LDMC CWM

- Same trend observed between all climates
- Same trend observed between all treatments
- Arid:
    - Arid-Partial < Arid-Total
    - No difference between Partial and Open
    - No difference between Total and Open
- Int:
   - Int-Partial < Int-Total
   - No difference between Partial and Open
   - No difference between Total and Open
- Mesic: 
    - Mesic-Partial < Mesic-Total
    - No difference between Partial and Open
    - No difference between Total and Open
- Open treatment:
    - Int-Open > Arid-Open
    - Int-Open > Mesic-Open
    - No difference between Arid-Open and Mesic-Open
- Partial Treatment:
    - Int-Partial > Arid-Partial
    - Int-Partial > Mesic-Partial
    - No difference between Arid-Partial and Mesic-Partial
- Total Treatment:
    - Int-Total > Arid-Total
    - Int-Total > Mesic-Total
    - No difference between Arid-Total and Mesic-Total

```{r}
LDMC_CWM <- glm(data = cwm_traits_adj, weighted_ldmc ~ climate * treatment, family = gaussian, na.action = na.fail) 
dredge(LDMC_CWM) #best model: weighted_ldmc ~ climate + treatment
LDMC_CWM <- glm(data = cwm_traits_adj, weighted_ldmc ~ climate + treatment, family = gaussian, na.action = na.fail) 

simulateResiduals(LDMC_CWM, plot= T) #looks good
shapiro.test(residuals(LDMC_CWM)) #normal

LDMC_sig_pairs <- as.data.frame(pairs(emmeans(LDMC_CWM, ~climate + treatment))) %>% 
  filter(p.value <= 0.05)

emmeans(LDMC_CWM, pairwise ~ climate)
emmeans(LDMC_CWM, pairwise ~ treatment)
# emmeans(LDMC_CWM, pairwise ~ climate + treatment)
emmeans(LDMC_CWM, pairwise ~ climate | treatment)


simulateResiduals(LDMC_CWM, plot= T) #looks good
shapiro.test(residuals(LDMC_CWM)) #normal

LDMC_sig_pairs <- as.data.frame(pairs(emmeans(LDMC_CWM, ~climate + treatment))) %>% 
  filter(p.value <= 0.05)

emmeans(LDMC_CWM, pairwise ~ climate)
emmeans(LDMC_CWM, pairwise ~ treatment)
# emmeans(LDMC_CWM, pairwise ~ climate + treatment)
emmeans(LDMC_CWM, pairwise ~ climate | treatment)
emmeans(LDMC_CWM, pairwise ~ treatment | climate)
emmeans(LDMC_CWM, pairwise ~ treatment * climate)

plot(emmeans(LDMC_CWM, pairwise ~ treatment | climate), comparisons = TRUE)

multcomp::cld(emmeans(LDMC_CWM, ~ treatment), alpha = 0.05, Letters = LETTERS)

```

#### d. Seed mass CWM

- same trend observed across climates
- same trend observed across herbivore treatments
-Arid
    - Arid-Total > Arid-Open
    - No difference between Arid-Open and Arid-Partial
    - No difference between Arid-Partial and Arid-Total
- Int
    -Int-Total > Int-Open
    - No difference between Int-Open and Int-Partial
    - No difference between Int-Partial and Int-Total
- Mesic
    -Mesic-Total > Mesic-Open
    - No difference between Mesic-Open and Mesic-Partial
    - No difference between Mesic-Partial and Mesic-Total
- Open:
  - Int Open > Mesic-Open
  - No difference between Arid and Mesic
- Partial:
    - Int-Partial > Mesic-Partial
    - No difference between Arid and Mesic
- Total:
    - Int-Total > Mesic-Total
    - No difference between Arid and Mesic

```{r}
seed_mass_CWM <- glm(data = cwm_traits_adj, weighted_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(seed_mass_CWM) #best model: weighted_seed_mass ~ cliamte + treatment
seed_mass_CWM <- glm(data = cwm_traits_adj, weighted_seed_mass ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(seed_mass_CWM, plot= T) #model predictions look a little wonky, but it says it's good.  I'm also getting something saying that "outer Newton did not converge fully?
shapiro.test(residuals(seed_mass_CWM)) # not normal

# log transformation
log_seed_mass <- glm(data = cwm_traits_adj, log_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(log_seed_mass) #best model: weighted_seed_mass ~ cliamte + treatment
log_seed_mass <- glm(data = cwm_traits_adj, log_seed_mass ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(log_seed_mass, plot= T) #looks ok
shapiro.test(residuals(log_seed_mass)) #normal

#pairwise comparisons
seed_sig_pairs <-  as.data.frame(pairs(emmeans(log_seed_mass, ~ climate + treatment))) %>% 
  filter(p.value <= 0.05)

emmeans(log_seed_mass, pairwise ~ climate)
emmeans(log_seed_mass, pairwise ~ treatment)
# emmeans(log_seed_mass, pairwise ~ climate + treatment)
emmeans(log_seed_mass, pairwise ~ treatment * climate)

plot(emmeans(log_seed_mass, pairwise ~ treatment | climate))
multcomp::cld(emmeans(log_seed_mass, ~ treatment), alpha = 0.05, Letters = LETTERS)

```

#### e. Leaf-N CWM

- No difference between any of the different herbivore treatments within climates
- Same pattern observed between treatments at different climates

- Arid:
    - No difference between treatments at Arid
- Int:
     - No difference between  treatments at Int
- Mesic:
    - No difference between treatments at Mesic
- Open:
    - Arid-Open > Mesic-Open
    - Int-Open > Mesic-Open
- Partial:
    - Arid-Partial > Mesic-Partial
    - Int-Partial > Mesic-Partial
- Total:
    - Arid-Total > Mesic-Total
    - Int-Total > Mesic-Total


```{r} 
leaf_n_CWM <- glm(data = cwm_traits_adj, weighted_n ~ climate * treatment, family = gaussian, na.action = na.fail) 
dredge(leaf_n_CWM) #best model: weighted_n ~ climate + treatment
leaf_n_CWM <- glm(data = cwm_traits_adj, weighted_n ~ climate + treatment, family = gaussian, na.action = na.fail) 

simulateResiduals(leaf_n_CWM, plot= T) #looks bad
shapiro.test(residuals(leaf_n_CWM)) #not normal

#log transformation
log_n_CWM <- glm(data = cwm_traits_adj, log_n ~ climate * treatment, family = gaussian, na.action = na.fail) 
dredge(log_n_CWM) #get: Fixed terms are "cond((Int))" and "disp((Int))"
log_n_CWM <- glm(data = cwm_traits_adj, log_n ~ climate + treatment, family = gaussian, na.action = na.fail) 

simulateResiduals(log_n_CWM, plot= T) #doesn't look very good
shapiro.test(residuals(log_n_CWM)) #p = 0.05924

# Model summary
emmeans(log_n_CWM, ~climate + treatment)
LNC_pairs <-  as.data.frame(pairs(emmeans(log_n_CWM, ~ climate + treatment)))
LNC_sig_pairs <- LNC_pairs %>% 
  filter(p.value <= 0.05)

# emmeans(log_n_CWM, pairwise ~ climate + treatment)
emmeans(log_n_CWM, pairwise ~ climate | treatment)

plot(emmeans(log_n_CWM, pairwise ~ treatment | climate))
multcomp::cld(emmeans(log_n_CWM, ~ treatment), alpha = 0.05, Letters = LETTERS)
```

#### f. Best-fit Model Table

```{r}
dredge_LA <- as.data.frame(dredge(LA_CWM)) %>%
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Leaf Area") %>% 
  dplyr::select(CWM, climate, treatment, "climate:treatment")

dredge_SLA <-  as.data.frame(dredge(SLA_CWM)) %>% 
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Specific Leaf Area") %>%
  select(CWM, climate, treatment, "climate:treatment")

dredge_LDMC <- as.data.frame(dredge(LDMC_CWM)) %>% 
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Leaf Dry Matter Content") %>%
  select(CWM, climate, treatment)

dredge_log_seed_mass <- as.data.frame(dredge(log_seed_mass)) %>% 
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Seed Mass (log)") %>%
  select(CWM, climate, treatment)

dredge_log_n <- as.data.frame(dredge(log_n_CWM)) %>% 
  filter(AICc == min(AICc)) %>% 
  mutate(CWM = "Leaf Nitrogen Content (log)") %>%
  select(CWM, climate, treatment)

dredge_table <- dredge_LA %>% 
  full_join(dredge_SLA) %>% 
  full_join(dredge_LDMC) %>% 
  full_join(dredge_log_seed_mass) %>% 
  full_join(dredge_log_n) %>% 
  mutate(climate = str_replace(climate, "\\+","x")) %>%
  mutate(treatment = str_replace(treatment, "\\+","x")) %>% 
  mutate(`climate:treatment` = str_replace(`climate:treatment`, "\\+","x"))

# Trying gt package
# data must be a tibble

pretty_table <- dredge_table %>% 
  as_tibble() %>% 
  gt() %>% 
  tab_header(
    title = "CWM Best-Fit Models"
  ) %>% 
  tab_spanner(
    label = "Fixed Effects Terms",
    columns = vars(climate, treatment, "climate:treatment")
  ) %>% 
  fmt_missing(
    columns = vars(climate, treatment, "climate:treatment"),
    missing_text = " "
  ) %>% 
  tab_source_note(
    source_note = "x indicates selection of fixed effect term for best-fit model"
  )

# pretty_table

gtsave(data = pretty_table, filename = "CWM_AIC_table.png", path = "~/github/Tejon_Functional_Traits/Figures")

```

#### g. EMM Graphs

```{r}

# arrow_colors <- function(climates){
#   if (climates == "Arid") return({"red"})
#   if (climates == "Intermediate") return({"orange"})
#   if (climates == "Mesic") return({"blue"})
# }
# 
# arrow_colors <- function(input){
#   if (input == "Open") return({"red"})
#   if (input == "Partial") return({"orange"})
#   if (input == "Total") return({"blue"})
# }

arrow_colors <- (rep(c("red", "orange", "blue"), 3))

# making a function
emm_plot <- function(model, Climate = TRUE, Treatment = TRUE) {
  
  if (Climate == TRUE && Treatment == TRUE) return({
    
    plot(emmeans(model, ~treatment | climate ),
         CIs = FALSE,
         type = "response",
         comparisons = TRUE,
         colors = c("black", "black", "blue", "red")) + # color names for estimates, CIs, PIs, and comparison arrows, respectively
      labs(x = "EMM", y = "Climate") +
      facet_grid(. ~climate) +
      aes(fill = as.factor(treatment)) +
      geom_segment(aes_(x = ~the.emmean, xend = ~lcmpl, y = ~pri.fac, yend = ~pri.fac), #copied from function's code on github
               arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
               color = arrow_colors) +
      geom_segment(ggplot2::aes_(x = ~the.emmean, xend = ~rcmpl, y = ~pri.fac, yend = ~pri.fac),
               arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
               color = arrow_colors) +
      coord_flip() +
      geom_point(aes_(fill = "black"))+
      theme_bw() +
      theme(legend.position = "none")

    })
  
  if (Climate == TRUE && Treatment == FALSE) return({
    
    plot(emmeans(model, ~climate),
         CIs = FALSE,
         type = "response",
         comparisons = TRUE,
         colors = c("black", "black", "blue", "red")) + # color names for estimates, CIs, PIs, and comparison arrows, respectively
      labs(x = "EMM", y = "Climate") +
      facet_grid(. ~climate) +
      aes(fill = as.factor(treatment)) +
      geom_segment(aes_(x = ~the.emmean, xend = ~lcmpl, y = ~pri.fac, yend = ~pri.fac), #copied from function's code on github
               arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
               color = arrow_colors) +
      geom_segment(ggplot2::aes_(x = ~the.emmean, xend = ~rcmpl, y = ~pri.fac, yend = ~pri.fac),
               arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
               color = arrow_colors) +
      coord_flip() +
      geom_point(aes_(fill = "black"))+
      theme_bw() +
      theme(legend.position = "none")

    })
  
  if (Climate == FALSE && Treatment == TRUE) return({
    
    plot(emmeans(model, ~treatment),
         CIs = FALSE,
         type = "response",
         comparisons = TRUE,
         colors = c("black", "black", "blue", "red")) + # color names for estimates, CIs, PIs, and comparison arrows, respectively
      labs(x = "EMM", y = "Climate") +
      facet_grid(. ~climate) +
      aes(fill = as.factor(treatment)) +
      geom_segment(aes_(x = ~the.emmean, xend = ~lcmpl, y = ~pri.fac, yend = ~pri.fac), #copied from function's code on github
               arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
               color = arrow_colors) +
      geom_segment(ggplot2::aes_(x = ~the.emmean, xend = ~rcmpl, y = ~pri.fac, yend = ~pri.fac),
               arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
               color = arrow_colors) +
      coord_flip() +
      geom_point(aes_(fill = "black"))+
      theme_bw() +
      theme(legend.position = "none")

    })
  
  if (Climate == FALSE && Treatment == FALSE) return({
    print("no inputs")
    })
}

# plot(emmeans(LA_CWM, ~ treatment | climate),
#      CIs = FALSE,
#      type = "response",
#      comparisons = TRUE,
#     colors = c("black", "black", "blue", "red")) + # color names for estimates, CIs, PIs, and comparison arrows, respectively
#   labs(x = "EMM", y = "Climate") +
#   facet_grid(. ~climate) +
#   aes(fill = as.factor(treatment)) +
#   geom_segment(aes_(x = ~the.emmean, xend = ~lcmpl, y = ~pri.fac, yend = ~pri.fac), #copied from function's code on github
#                arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
#                color = arrow_colors) +
#   geom_segment(ggplot2::aes_(x = ~the.emmean, xend = ~rcmpl, y = ~pri.fac, yend = ~pri.fac),
#                arrow = arrow(length = ggplot2::unit(.07, "inches"), type = "closed"),
#                color = arrow_colors) +
#   coord_flip() +
#   geom_point(aes_(fill = "black"))+
#   theme_bw() +
#   theme(legend.position = "none")

# la_emm <- emmeans(LA_CWM, ~ climate)
# la_emm <- emmeans(LA_CWM, ~ treatment)
# la_emm <- emmeans(LA_CWM, ~ treatment * climate)
# la_cdf <- multcomp::cld(la_emm, level = 0.05, Letters = LETTERS)
# plot(emmeans(LA_CWM, ~ treatment * climate), comparisons = TRUE)

# Leaf Area
plot1 <- emm_plot(model = LA_CWM, Climate = TRUE, Treatment = TRUE) +
  labs(title = "Leaf Area CWM")
plot1

# SLA
plot2 <- emm_plot(model = SLA_CWM) +
  labs(title = "Specific Leaf Area CWM")

# LDMC
plot3 <- emm_plot(model = LDMC_CWM) +
  labs(title = "Leaf Dry Matter Content CWM")

# Seed Mass
plot4 <- emm_plot(model = log_seed_mass) +
  labs(title = "Seed Mass (log) CWM")

# LNC
plot5 <- emm_plot(model = log_n_CWM) +
  labs(title = "Leaf Nitrogen Content (log) CWM")

CWM_emmeans_all <- grid.arrange(plot1, plot2, plot3, plot4, plot5, ncol = 2)

ggsave("CWM_emmeans_3.png", plot = CWM_emmeans_all, path = "~/github/Tejon_Functional_Traits/Figures", height = 10, width = 10)

```

#### h. testing model summary package

```{r}
library(modelsummary)

modelsummary::datasummary_skim(cwm_traits_adj)

models <- list("SLA" = SLA_CWM, 
               "Leaf Area" = LA_CWM)

names <- c("climateIntermediate" = "Intermediate Climate", 
           "climateMesic" = "Mesic Climate",
           "treatmentTotal" = "Total Treatment",
           "treatmentPartial" = "Partial Treatment",
           "climateIntermediate × treatmentPartial"= "Intermediate Climate × Partial Treatment")

modelsummary::modelsummary(models, 
                           title = "Community-weighted Means Models",
                           coef_rename = names,
                           stars = TRUE) # won't let me change name of interaction coefficients

```

### Functional Groups

- I started setting this up to look at changes in weighted means when grouped by functional group, but I think it would be more interesting to use the species-level, un-weighted data.

```{r}
cwm_functional <-  read_csv("~/github/Tejon_Functional_Traits/Datasheets/cwm_traits_updated.csv") %>%
  left_join(other_traits, by = "species_name") %>% 
  mutate(weighted_la = leaf_area * Abundance) %>% #multiplying trait values by species abundance
  mutate(weighted_sla = sla * Abundance) %>% 
  mutate(weighted_ldmc = ldmc * Abundance) %>%
  mutate(weighted_seed_mass = seed_mass * Abundance) %>%
  mutate(weighted_n = leaf_n * Abundance) %>%
  group_by(climate, treatment, Block, functional_group) %>% #grouping by climate, treatment, and block
  summarise_all(mean, na.rm = TRUE) %>% #finding the mean
  dplyr::select(climate, treatment, functional_group, weighted_la, weighted_sla, weighted_ldmc, weighted_seed_mass, weighted_n)

cwm_functional %>%
  pivot_longer(cols = weighted_la:weighted_n,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(traits ~ functional_group, scales = "free")

grass <- cwm_functional %>% 
  filter(functional_group == "grass")

forb <- cwm_functional %>% 
  filter(functional_group == "forb") %>% 
  mutate(sqrt_la = sqrt(weighted_la))

shrub <- cwm_functional %>% 
  filter(functional_group == "shrub")
  
```

#### CWMs with interaction between climate, treatment, and functional group

##### leaf area
```{r}
#leaf area is very skewed:
ggplot(cwm_functional, aes(x = weighted_la)) +
  geom_histogram() +
  theme_bw()+
  facet_wrap(~functional_group)

#trying glm
funct_la <- glm(data = cwm_functional, weighted_la ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_la)

simulateResiduals(funct_la, plot= T) #does not pass dispersion test
shapiro.test(residuals(funct_la)) #but residuals are normal

testDispersion(simulateResiduals(funct_la, plot= T)) # does not pass

#trying log transformation with gaussian
cwm_functional <- cwm_functional %>% 
  mutate(log_la = log(weighted_la))

ggplot(cwm_functional, aes(x = log_la)) +
  geom_histogram() +
  theme_bw()+
  facet_wrap(~functional_group)

funct_la <- glm(data = cwm_functional, log_la ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_la)
funct_la <- glm(data = cwm_functional, log_la ~ climate + treatment + functional_group + climate:functional_group + functional_group:treatment, family = gaussian, na.action = na.fail)

simulateResiduals(funct_la, plot= T) #looks good
shapiro.test(residuals(funct_la)) # but residuals are not normal

# trying Gamma with log link on un-transformed
funct_la <- glm(data = cwm_functional, weighted_la ~ climate * treatment * functional_group, family = Gamma(link = "log"), na.action = na.fail)
dredge(funct_la)
funct_la <- glm(data = cwm_functional, weighted_la ~ climate + treatment + functional_group + climate:functional_group + functional_group:treatment, family = Gamma(link = "log"), na.action = na.fail)

simulateResiduals(funct_la, plot= T) #does not pass dispersion test, but is very close!
shapiro.test(residuals(funct_la)) #but residuals are normal

#trying log+1 with gaussian
cwm_functional <- cwm_functional %>% 
  mutate(log_plus_la = log(weighted_la + 1))

ggplot(cwm_functional, aes(x = log_plus_la)) +
  geom_histogram() +
  theme_bw()

funct_la <- glm(data = cwm_functional, log_plus_la ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_la)
funct_la <- glm(data = cwm_functional, log_plus_la ~ climate + treatment + functional_group + climate:functional_group + functional_group:treatment, family = gaussian, na.action = na.fail)

simulateResiduals(funct_la, plot= T) #good
shapiro.test(residuals(funct_la)) #residuals are normal

emmeans(funct_la, pairwise ~ climate | treatment | functional_group)
emmeans(funct_la, pairwise ~ treatment | functional_group)
emmeans(funct_la, pairwise ~ functional_group)

# LA_funct_sig_pairs <- as.data.frame(pairs(emmeans(funct_la, ~ climate * treatment * functional_group))) %>% 
#   separate(contrast, c("A", "B"), sep = " - ") %>% 
#   separate(A, c("A_climate", "A_treatment", "A_functional_group"), sep = ",") %>% 
#   separate(B, c("B_climate", "B_treatment", "B_functional_group"), sep = ",") %>% 
#   filter((A_climate == B_climate & A_functional_group == B_functional_group) | 
#           (A_climate == B_climate & A_treatment == B_treatment) | 
#            (A_treatment == B_treatment & A_functional_group == B_functional_group))
# LA_funct_sig_pairs

```
##### specific leaf area
```{r}
#leaf area is very skewed:
ggplot(cwm_functional, aes(x = weighted_sla)) +
  geom_histogram() +
  theme_bw()+
  facet_wrap(~functional_group)

cwm_functional <- cwm_functional %>% 
  mutate(log_sla = log(weighted_sla))

funct_sla <- glm(data = cwm_functional, weighted_sla ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_sla)

simulateResiduals(funct_sla, plot= T) #does not pass dispersion test
shapiro.test(residuals(funct_sla)) # not normal

#trying log transformation with gaussian
funct_sla <- glm(data = cwm_functional, log_sla ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_sla)
funct_sla <- glm(data = cwm_functional, log_sla ~ climate + functional_group + treatment + climate:functional_group, family = gaussian, na.action = na.fail)

simulateResiduals(funct_sla, plot= T) # good
shapiro.test(residuals(funct_sla)) # not normal

# trying Gamma with log link on un-transformed
funct_sla <- glm(data = cwm_functional, weighted_sla ~ climate * treatment * functional_group, family = Gamma, na.action = na.fail)
dredge(funct_sla)
funct_sla <- glm(data = cwm_functional, weighted_sla ~ climate + functional_group + treatment + climate:functional_group, family = Gamma, na.action = na.fail)

simulateResiduals(funct_sla, plot= T) # not normal
shapiro.test(residuals(funct_sla)) # not normal

#trying log+1 with gaussian
cwm_functional <- cwm_functional %>% 
  mutate(log_plus_sla = log(weighted_sla + 1))

funct_sla <- glm(data = cwm_functional, log_plus_sla ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_sla)
funct_sla <- glm(data = cwm_functional, log_plus_sla ~ climate + functional_group + treatment + climate:functional_group, family = gaussian, na.action = na.fail)

simulateResiduals(funct_sla, plot= T) #good
shapiro.test(residuals(funct_sla)) #normal

emmeans(funct_sla, pairwise ~ climate | treatment | functional_group)
emmeans(funct_sla, pairwise ~ treatment | functional_group)
emmeans(funct_sla, pairwise ~ functional_group)

```
##### ldmc
```{r}
cwm_functional <- cwm_functional %>% 
  mutate(log_ldmc = log(weighted_ldmc))

funct_ldmc <- glm(data = cwm_functional, weighted_ldmc ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_ldmc)
funct_ldmc <- glm(data = cwm_functional, weighted_ldmc ~ climate + functional_group + treatment + climate:functional_group + functional_group:treatment, na.action = na.fail)

simulateResiduals(funct_ldmc, plot= T) # does not pass dispersion test
shapiro.test(residuals(funct_ldmc)) # not normal

funct_ldmc <- glm(data = cwm_functional, log_ldmc ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_ldmc)
funct_ldmc <- glm(data = cwm_functional, log_ldmc ~ climate + functional_group + treatment + climate:functional_group + functional_group:treatment, na.action = na.fail)

simulateResiduals(funct_ldmc, plot= T) # ok
shapiro.test(residuals(funct_ldmc)) # normal

emmeans(funct_ldmc, pairwise ~ climate | treatment | functional_group)
emmeans(funct_ldmc, pairwise ~ treatment | functional_group)
emmeans(funct_ldmc, pairwise ~ functional_group)
```
##### lnc
```{r}
funct_n <- glm(data = cwm_functional, weighted_n ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_n)
funct_n <- glm(data = cwm_functional, weighted_n ~ climate + functional_group + treatment + climate:functional_group + functional_group:treatment, na.action = na.fail)

simulateResiduals(funct_n, plot= T) # not good
shapiro.test(residuals(funct_n)) # not normal

cwm_functional <- cwm_functional %>% 
  mutate(log_n = log(weighted_n)) %>% 
  mutate(log_plus_n = log(weighted_n+1))

# trying log transformation with gaussian
funct_n <- glm(data = cwm_functional, log_n ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_n)
funct_n <- glm(data = cwm_functional, log_n ~ climate + functional_group + treatment + climate:functional_group, na.action = na.fail)

simulateResiduals(funct_n, plot= T) # looks ok
shapiro.test(residuals(funct_n)) # not normal

# trying log(n+1) transformation with gaussian
funct_n <- glm(data = cwm_functional, log_plus_n ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_n)
funct_n <- glm(data = cwm_functional, log_plus_n ~ climate + functional_group + treatment + climate:functional_group, na.action = na.fail)

simulateResiduals(funct_n, plot= T) # looks ok
shapiro.test(residuals(funct_n)) # normal

emmeans(funct_n, pairwise ~ climate | treatment | functional_group)
emmeans(funct_n, pairwise ~ treatment | functional_group)
emmeans(funct_n, pairwise ~ functional_group)

```
##### seed mass
```{r}
funct_seed_mass <- glm(data = cwm_functional, weighted_seed_mass ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_seed_mass)
funct_seed_mass <- glm(data = cwm_functional, weighted_seed_mass ~ climate + functional_group + treatment + climate:functional_group, na.action = na.fail)

simulateResiduals(funct_seed_mass, plot= T) # bad
shapiro.test(residuals(funct_seed_mass)) # not normal

# log transformation with gaussian
cwm_functional <- cwm_functional %>% 
  mutate(log_seed_mass = log(weighted_seed_mass))

funct_seed_mass <- glm(data = cwm_functional, log_seed_mass ~ climate * treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_seed_mass)
funct_seed_mass <- glm(data = cwm_functional,log_seed_mass ~ climate + functional_group + climate:functional_group, na.action = na.fail)

simulateResiduals(funct_seed_mass, plot= T) # ok
shapiro.test(residuals(funct_seed_mass)) # normal

# for back transformation
funct_seed_mass <- glm(data = cwm_functional, log(weighted_seed_mass) ~ climate + functional_group + climate:functional_group, na.action = na.fail)

funct_seed_mass_emm <- emmeans(funct_seed_mass, ~ climate * functional_group)
summary(funct_seed_mass_emm) # results are given on a log scale
summary(funct_seed_mass_emm, infer = TRUE, null = log(35), type = "response")

funct_seed_mass.rg <- update(ref_grid(funct_seed_mass), tran = make.tran("genlog", 1))

contrast(regrid(funct_seed_mass.rg))

emmeans(funct_seed_mass.rg, pairwise ~ climate | functional_group)
emmeans(funct_seed_mass, pairwise ~ climate | functional_group)
emmeans(funct_seed_mass, pairwise ~ climate | functional_group)
emmeans(funct_seed_mass, pairwise ~ functional_group)

```
#### Individual Models:
#### a. grasses:
##### i. leaf area
```{r}
grass_la <- glm(data = grass, weighted_la ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_la) # best model: trait ~ climate * treatment

simulateResiduals(grass_la, plot= T) #good
shapiro.test(residuals(grass_la)) #normal

summary(grass_la)
emmeans(grass_la, pairwise ~ climate)
emmeans(grass_la, pairwise ~ treatment | climate)
```
##### ii. specific leaf area
```{r}
grass_sla <- glm(data = grass, weighted_sla ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_sla) # best model: trait ~ climate * treatment

simulateResiduals(grass_sla, plot= T) # good
shapiro.test(residuals(grass_sla)) # normal

summary(grass_sla)
emmeans(grass_sla, pairwise ~ climate)
emmeans(grass_sla, pairwise ~ treatment | climate)
```
##### iii.ldmc
```{r}
grass_ldmc <- glm(data = grass, weighted_ldmc ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_ldmc) # best model: trait ~ climate + treatment
grass_ldmc <- glm(data = grass, weighted_ldmc ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(grass_ldmc, plot= T) # not good
shapiro.test(residuals(grass_ldmc)) # not normal

grass <- grass %>% 
  mutate(log_ldmc = log(weighted_ldmc))

grass_ldmc <- glm(data = grass, log_ldmc ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_ldmc) # best model: trait ~ climate
grass_ldmc <- glm(data = grass, log_ldmc ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(grass_ldmc, plot= T) # good
shapiro.test(residuals(grass_ldmc)) # normal

summary(grass_ldmc)
emmeans(grass_ldmc, pairwise ~ climate)
```
##### iv. lnc
```{r}
grass_n <- glm(data = grass, weighted_n ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_n) # best model: trait ~ climate
grass_n <- glm(data = grass, weighted_n ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(grass_n, plot= T) # good
shapiro.test(residuals(grass_n)) # normal

summary(grass_n)
emmeans(grass_n, pairwise ~ climate)
```
##### v. seed mass
```{r}
grass_seed_mass <- glm(data = grass, weighted_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
boxcox(grass_seed_mass) # might be best to do ln transformation
dredge(grass_seed_mass) # best model: trait ~ climate + treatment
grass_seed_mass <- glm(data = grass, weighted_seed_mass ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # not good
shapiro.test(residuals(grass_seed_mass)) # normal

grass <- grass %>% 
  mutate(log_seed_mass = log(weighted_seed_mass)) %>% 
  mutate(ln_seed_mass = log10(weighted_seed_mass)) %>% 
  mutate(sqrt_seed_mass = sqrt(weighted_seed_mass))

grass_seed_mass <- glm(data = grass, log_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_seed_mass) # best model: trait ~ climate
grass_seed_mass <- glm(data = grass, log_seed_mass ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # ok?
shapiro.test(residuals(grass_seed_mass)) # not normal

grass_seed_mass <- glm(data = grass, ln_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_seed_mass) # best model: trait ~ climate
grass_seed_mass <- glm(data = grass, ln_seed_mass ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # ok?
shapiro.test(residuals(grass_seed_mass)) # not normal

grass_seed_mass <- glm(data = grass, sqrt_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(grass_seed_mass) # best model: trait ~ climate + treatment
grass_seed_mass <- glm(data = grass, sqrt_seed_mass ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # not ok
shapiro.test(residuals(grass_seed_mass)) # normal

# gamma distribution worked all along
grass_seed_mass <- glm(data = grass, weighted_seed_mass ~ climate * treatment, family = Gamma, na.action = na.fail)
dredge(grass_seed_mass) # best model: trait ~ climate + treatment
grass_seed_mass <- glm(data = grass, weighted_seed_mass ~ climate + treatment, family = Gamma, na.action = na.fail)

simulateResiduals(grass_seed_mass, plot= T) # good
shapiro.test(residuals(grass_seed_mass)) # normal

summary(grass_seed_mass)
emmeans(grass_seed_mass, pairwise ~ climate)
emmeans(grass_seed_mass, pairwise ~ treatment | climate)
```
#### b. forbs
##### i. la
```{r}
forb_la <- glm(data = forb, log_la ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_la) # best model is climate + treatment
forb_la <- glm(data = forb, log_la ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(forb_la, plot= T) # ok
shapiro.test(residuals(forb_la)) #normal

summary(forb_la)
emmeans(forb_la, pairwise ~ climate)
emmeans(forb_la, pairwise ~ treatment | climate)
```
##### ii. sla
```{r}
forb_sla <- glm(data = forb, weighted_sla ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_sla) # best model is only climate
forb_sla <- glm(data = forb, weighted_sla ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(forb_sla, plot= T) # ok
shapiro.test(residuals(forb_sla)) # not normal

forb_sla <- glm(data = forb, weighted_sla ~ climate * treatment, family = Gamma, na.action = na.fail)
dredge(forb_sla) # best model: trait ~ climate
forb_sla <- glm(data = forb, weighted_sla ~ climate, family = Gamma, na.action = na.fail)

simulateResiduals(forb_sla, plot= T) # ok
shapiro.test(residuals(forb_sla)) # normal

summary(forb_sla)
emmeans(forb_sla, pairwise ~ climate)
```
##### iii. ldmc
```{r}
forb_ldmc <- glm(data = forb, weighted_ldmc ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_ldmc) # best model: trait ~ treatment
forb_ldmc <- glm(data = forb, weighted_ldmc ~ treatment, family = gaussian, na.action = na.fail)

simulateResiduals(forb_ldmc, plot= T) # ok
shapiro.test(residuals(forb_ldmc)) # normal

summary(forb_ldmc)
emmeans(forb_ldmc, pairwise ~ treatment)
```
##### iv.lnc
```{r}
forb_leaf_n <- glm(data = forb, weighted_n ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_leaf_n) # best model: trait ~ climate
forb_leaf_n <- glm(data = forb, weighted_n ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(forb_leaf_n, plot= T) # ok
shapiro.test(residuals(forb_leaf_n)) # normal

summary(forb_leaf_n)
emmeans(forb_leaf_n, pairwise ~ climate)
```
##### v.seed mass
```{r}
forb_seed_mass <- glm(data = forb, weighted_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_seed_mass) # best model: trait ~ climate * treatment

simulateResiduals(forb_seed_mass, plot= T) # not good
shapiro.test(residuals(forb_seed_mass)) # not normal

forb_seed_mass <- glm(data = forb, weighted_seed_mass ~ climate * treatment, family = Gamma, na.action = na.fail)
dredge(forb_seed_mass) # best model: trait ~ climate * treatment

simulateResiduals(forb_seed_mass, plot= T) # ok
shapiro.test(residuals(forb_seed_mass)) # not normal

forb <- forb %>% 
  mutate(log_seed_mass = log(weighted_seed_mass))

forb_seed_mass <- glm(data = forb, log_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(forb_seed_mass) # best model: trait ~ climate
forb_seed_mass <- glm(data = forb, log_seed_mass ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(forb_seed_mass, plot= T) # ok
shapiro.test(residuals(forb_seed_mass)) # normal

summary(forb_seed_mass)
emmeans(forb_seed_mass, pairwise ~ climate)
```
#### c. shrubs
##### i.la
- what do you do when residuals are normal but the residual vs. predicted plot looks terrible?
```{r}
shrub_la <- glm(data = shrub, weighted_la ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_la) # best model: trait ~ climate + treatment
shrub_la  <- glm(data = shrub, weighted_la ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_la, plot= T) # very bad
shapiro.test(residuals(shrub_la)) # normal

summary(shrub_la)
emmeans(shrub_la, pairwise ~ climate)
```
##### ii.sla
```{r}
shrub_sla <- glm(data = shrub, weighted_sla ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_sla) # best model: trait ~ 1
shrub_sla  <- glm(data = shrub, weighted_sla ~ 1, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_sla, plot= T) # fine
shapiro.test(residuals(shrub_sla)) # normal

```
##### iii.ldmc
```{r}
shrub_ldmc <- glm(data = shrub, weighted_ldmc ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_ldmc) # best model: trait ~ treatment; NEED TO DO MODEL AVERAGING
shrub_ldmc  <- glm(data = shrub, weighted_ldmc ~ treatment, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_ldmc, plot= T) # fine
shapiro.test(residuals(shrub_ldmc)) # normal

summary(shrub_ldmc)
emmeans(shrub_ldmc, pairwise ~ treatment)
```
##### iv.lnc
```{r}
shrub_n <- glm(data = shrub, weighted_n ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_n) # NEED TO DO MODEL AVERAGING
shrub_n  <- glm(data = shrub, weighted_n ~ treatment, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_n, plot= T) # fine
shapiro.test(residuals(shrub_n)) # normal

summary(shrub_n)
emmeans(shrub_n, pairwise ~ treatment)
```
##### v.seed mass
```{r}
shrub_seed_mass <- glm(data = shrub, weighted_seed_mass ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(shrub_seed_mass) # NEED TO DO MODEL AVERAGING
shrub_seed_mass  <- glm(data = shrub, weighted_seed_mass ~ climate + treatment, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_seed_mass, plot= T) # bad
shapiro.test(residuals(shrub_seed_mass)) # normal

summary(shrub_n)
emmeans(shrub_n, pairwise ~ treatment)

```
