---
title: "CWM_Models"
author: "Maggie Klope"
date: "10/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(stats)
library(sjPlot)
library(FD)
library(DHARMa) #model diagnostics
library(glmmTMB) #model fitting
library(MuMIn) #model summaries and comparisons
library(emmeans) #post-hoc analyses
# library(performance) #for R2 values

cwm_traits_adj <-  read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  mutate(weighted_la = leaf_area * Abundance) %>% #multiplying trait values by species abundance
  mutate(weighted_sla = sla * Abundance) %>% 
  mutate(weighted_ldmc = ldmc * Abundance) %>%
  mutate(weighted_seed_mass = seed_mass * Abundance) %>%
  mutate(weighted_n = leaf_n * Abundance) %>%
  group_by(climate, treatment, Block) %>% #grouping by climate, treatment, and block
  summarise_all(mean, na.rm = TRUE) %>% #finding the mean
  select(climate, treatment, Block, weighted_la, weighted_sla, weighted_ldmc, weighted_seed_mass, weighted_n)

```

## GLMs for Community-weighted means (CWMs)

- Calculated with 2017 trait data
- again, one value per climate/treatment/block so no blocking effect included
- Include interaction between climate and treatment? AIC values for some are much higher without interaction

### Models:

**What is the effect of climate and grazing on community-weighted means?**

`lm(LA ~ Climate * Treatment, family = gaussian)`

```{r}
cwm_traits_adj %>%
  pivot_longer(cols = weighted_la:weighted_n,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_wrap(~traits, scales = "free")
```

```{r}

# # Looking at distributions
# # LA and SLA are not normally distributed, but glm residuals come back as normal
# 
# ggplot(cwm_traits_adj, aes(x = weighted_la)) +
#   geom_histogram() +
#   theme_bw()
# 
# shapiro.test(cwm_traits_adj$weighted_la) # not normal
# 
# ggplot(cwm_traits_adj, aes(x = weighted_sla)) +
#   geom_histogram() +
#   theme_bw()
# 
# shapiro.test(cwm_traits_adj$weighted_sla) # not normal
# 
# ggplot(cwm_traits_adj, aes(x = weighted_ldmc)) +
#   geom_histogram() +
#   theme_bw()
# 
# shapiro.test(cwm_traits_adj$weighted_ldmc) # normal
# 
# # seed mass and leaf n are not normally distributed, and the glm residuals come back as not normal, so I have done a log transformation:
# 
# ggplot(cwm_traits_adj, aes(x = weighted_seed_mass)) +
#   geom_histogram() +
#   theme_bw()
# 
# shapiro.test(cwm_traits_adj$weighted_seed_mass) # not normal
# 
# ggplot(cwm_traits_adj, aes(x = weighted_n)) +
#   geom_histogram() +
#   theme_bw()
# 
# shapiro.test(cwm_traits_adj$weighted_n) # not normal

# log transformation for seed mass & leaf n
cwm_traits_adj <- cwm_traits_adj %>% 
  mutate(log_seed_mass = log(weighted_seed_mass)) %>% 
  mutate(log_n = log(weighted_n))


```

#### a. Leaf Area CWM

```{r}
# Best fit model:
LA_CWM <- glmmTMB(data = cwm_traits_adj, weighted_la ~ climate * treatment, family = gaussian)
dredge(LA_CWM) #best model: weighted_la ~ climate * treatment

# Checking data
simulateResiduals(LA_CWM, plot= T) #What is the red asterisk on the model predictions graph?
shapiro.test(residuals(LA_CWM)) #normal

# Model summaries
summary(LA_CWM)

LA_sig_pairs <-  as.data.frame(pairs(emmeans(LA_CWM, ~climate * treatment))) %>% 
  filter(p.value <= 0.05)

emmeans(LA_CWM, pairwise ~ climate * treatment)

```

Leaf Area CWM:

- Arid Total LA CWM larger than all other plots
- Arid:
    - Arid Total > Arid Open and Arid Partial
    - No difference between Arid Open and Arid Partial
- Intermediate:
    - No difference between herbivore treatments
- Mesic:
    - No difference between herbivore treatments
- Total herbivore treatment:
    - Arid Total larger than Intermediate Total and Mesic Total
    - No difference between Int Total and Mesic Total
- No differences between Open or Partial Treatments across climates

#### b. SLA CWM

```{r}
# best fit model
SLA_CWM <- glmmTMB(data = cwm_traits_adj, weighted_sla ~ climate * treatment, family = gaussian) 
dredge(SLA_CWM) #best model: weighted_sla ~ climate * treatment
#NEED TO DO MODEL AVERAGE

# testing data
simulateResiduals(SLA_CWM, plot= T) #looks good
shapiro.test(residuals(SLA_CWM)) #normal

# model summary
summary(SLA_CWM)

SLA_sig_pairs <- as.data.frame(pairs(emmeans(SLA_CWM, ~climate * treatment)))%>% 
  filter(p.value <= 0.05)
SLA_sig_pairs

emmeans(LA_SLA, pairwise ~ climate * treatment)

# plot(pairs(emmeans(SLA_CWM, ~climate * treatment))) +
#   theme_bw(base_size = 18) +
#   geom_vline(xintercept=0, size=2, color="red")

```
SLA CWM:

- Once again, Arid Total larger than almost all other treatments
- Arid trends:
    - Arid Total larger than Arid Open and Arid Partial
    - No significant difference between Arid Total & Partial
- No different between Intermediate herbivore treatments
- No difference between Mesic herbivore treatments
- For Total exclosures, almost follows Arid > Int > Mesic
    - Arid Total > Mesic Total
    - Arid Total > Int total (almost significant, p=0.0546)
    - Int Total > Mesic Total
- Other significant difference:
    - Arid Open > Mesic Open

#### c. LDMC CWM

```{r}
LDMC_CWM <- glmmTMB(data = cwm_traits_adj, weighted_ldmc ~ climate * treatment, family = gaussian) 
dredge(LDMC_CWM) #best model: weighted_ldmc ~ climate + treatment
LDMC_CWM <- glmmTMB(data = cwm_traits_adj, weighted_ldmc ~ climate + treatment, family = gaussian) 

simulateResiduals(LDMC_CWM, plot= T) #looks good
shapiro.test(residuals(LDMC_CWM)) #normal

summary(LDMC_CWM)

LDMC_sig_pairs <- as.data.frame(pairs(emmeans(LDMC_CWM, ~climate * treatment))) %>% 
  filter(p.value <= 0.05)
LDMC_sig_pairs

emmeans(LDMC_CWM, pairwise ~ climate * treatment)

```
LDMC CWM:

- Same trend observed between all climates
- Same trend observed between all treatments
- Arid:
    - Arid-Partial < Arid-Total
    - No difference between Partial and Open
    - No difference between Total and Open
- Int:
   - Int-Partial < Int-Total
   - No difference between Partial and Open
   - No difference between Total and Open
- Mesic: 
    - Mesic-Partial < Mesic-Total
    - No difference between Partial and Open
    - No difference between Total and Open
- Open treatment:
    - Int-Open > Arid-Open
    - Int-Open > Mesic-Open
    - No difference between Arid-Open and Mesic-Open
- Partial Treatment:
    - Int-Partial > Arid-Partial
    - Int-Partial > Mesic-Partial
    - No difference between Arid-Partial and Mesic-Partial
- Total Treatment:
    - Int-Total > Arid-Total
    - Int-Total > Mesic-Total
    - No difference between Arid-Total and Mesic-Total

#### d. Seed mass CWM

```{r}
seed_mass_CWM <- glmmTMB(data = cwm_traits_adj, weighted_seed_mass ~ climate * treatment, family = gaussian)
dredge(seed_mass_CWM) #best model: weighted_seed_mass ~ cliamte + treatment
seed_mass_CWM <- glmmTMB(data = cwm_traits_adj, weighted_seed_mass ~ climate + treatment, family = gaussian)

simulateResiduals(seed_mass_CWM, plot= T) #model predictions look a little wonky, but it says it's good.  I'm also getting something saying that "outer Newton did not converge fully?
shapiro.test(residuals(seed_mass_CWM)) # not normal

# log transformation
log_seed_mass <- glmmTMB(data = cwm_traits_adj, log_seed_mass ~ climate * treatment, family = gaussian)
dredge(log_seed_mass) #best model: weighted_seed_mass ~ cliamte + treatment
log_seed_mass <- glmmTMB(data = cwm_traits_adj, log_seed_mass ~ climate + treatment, family = gaussian)

simulateResiduals(log_seed_mass, plot= T) #looks ok
shapiro.test(residuals(log_seed_mass)) #normal

summary(log_seed_mass)

seed_sig_pairs <-  as.data.frame(pairs(emmeans(log_seed_mass, ~ climate + treatment))) %>% 
  filter(p.value <= 0.05)
seed_sig_pairs

emmeans(log_seed_mass, pairwise ~ climate + treatment)

```

Seed mass CWM:

- same trend observed across climates
- same trend observed across herbivore treatments
-Arid
    - Arid-Total > Arid-Open
    - No difference between Arid-Open and Arid-Partial
    - No difference between Arid-Partial and Arid-Total
- Int
    -Int-Total > Int-Open
    - No difference between Int-Open and Int-Partial
    - No difference between Int-Partial and Int-Total
- Mesic
    -Mesic-Total > Mesic-Open
    - No difference between Mesic-Open and Mesic-Partial
    - No difference between Mesic-Partial and Mesic-Total
- Open:
  - Int Open > Mesic-Open
  - No difference between Arid and Mesic
- Partial:
    - Int-Partial > Mesic-Partial
    - No difference between Arid and Mesic
- Total:
    - Int-Total > Mesic-Total
    - No difference between Arid and Mesic

#### e. Leaf-N CWM
```{r} 
leaf_n_CWM <- glmmTMB(data = cwm_traits_adj, weighted_n ~ climate * treatment, family = gaussian) 
dredge(leaf_n_CWM) #best model: weighted_n ~ climate + treatment
leaf_n_CWM <- glmmTMB(data = cwm_traits_adj, weighted_n ~ climate + treatment, family = gaussian) 

simulateResiduals(leaf_n_CWM, plot= T) #looks bad
shapiro.test(residuals(leaf_n_CWM)) #not normal

#log transformation
log_n_CWM <- glmmTMB(data = cwm_traits_adj, log_n ~ climate * treatment, family = gaussian) 
dredge(log_n_CWM) #get: Fixed terms are "cond((Int))" and "disp((Int))"
log_n_CWM <- glmmTMB(data = cwm_traits_adj, log_n ~ climate + treatment, family = gaussian) 

simulateResiduals(log_n_CWM, plot= T) #doesn't look very good
shapiro.test(residuals(log_n_CWM)) #p = 0.05924

# Model summary
summary(log_n_CWM)
emmeans(log_n_CWM, ~climate + treatment)
LNC_pairs <-  as.data.frame(pairs(emmeans(log_n_CWM, ~ climate + treatment)))
LNC_sig_pairs <- LNC_pairs %>% 
  filter(p.value <= 0.05)
LNC_sig_pairs

emmeans(log_n_CWM, pairwise ~ climate + treatment)
```
LNC CWM:

- No difference between any of the different herbivore treatments within climates
- Same pattern observed between treatments at different climates

- Arid:
    - No difference between treatments at Arid
- Int:
     - No difference between  treatments at Int
- Mesic:
    - No difference between treatments at Mesic
- Open:
    - Arid-Open > Mesic-Open
    - Int-Open > Mesic-Open
- Partial:
    - Arid-Partial > Mesic-Partial
    - Int-Partial > Mesic-Partial
- Total:
    - Arid-Total > Mesic-Total
    - Int-Total > Mesic-Total

### Functional Groups

```{r}
cwm_functional <-  read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  mutate(weighted_la = leaf_area * Abundance) %>% #multiplying trait values by species abundance
  mutate(weighted_sla = sla * Abundance) %>% 
  mutate(weighted_ldmc = ldmc * Abundance) %>%
  mutate(weighted_seed_mass = seed_mass * Abundance) %>%
  mutate(weighted_n = leaf_n * Abundance) %>%
  group_by(climate, treatment, Block, functional_group) %>% #grouping by climate, treatment, and block
  summarise_all(mean, na.rm = TRUE) %>% #finding the mean
  select(climate, treatment, functional_group, weighted_la, weighted_sla, weighted_ldmc, weighted_seed_mass, weighted_n)

grass <- cwm_functional %>% 
  filter(functional_group == "grass")

forb <- cwm_functional %>% 
  filter(functional_group == "forb")

shrub <- cwm_functional %>% 
  filter(functional_group == "shrub")
  
```

#### a. grasses

-need to come back to

```{r}

grass_la <- glmmTMB(data = grass, weighted_la ~ climate * treatment, family = gaussian)
dredge(grass_glm) # best model: trait ~ climate * treatment

simulateResiduals(grass_la, plot= T) #good
shapiro.test(residuals(grass_la)) #normal

summary(grass_la)
emmeans(grass_la, pairwise ~ climate + treatment)

```

#### b. forbs

```{r}
forb_la <- glmmTMB(data = forb, weighted_la ~ climate * treatment, family = gaussian)
dredge(forb_la) # NEED TO DO MODEL AVERAGING
forb_la <- glmmTMB(data = forb, weighted_la ~ treatment, family = gaussian)

simulateResiduals(forb_la, plot= T) #residuals vs. predicted not good
shapiro.test(residuals(forb_la)) #normal

```


#### c. shrubs

```{r}
shrub_la <- glmmTMB(data = shrub, weighted_la ~ climate * treatment, family = gaussian)
dredge(shrub_glm) # best model: trait ~ climate
shrub_la <- glmmTMB(data = shrub, weighted_la ~ climate, family = gaussian)

simulateResiduals(shrub_glm, plot= T) # can't do predicted plot
shapiro.test(residuals(shrub_glm)) #normal

```

