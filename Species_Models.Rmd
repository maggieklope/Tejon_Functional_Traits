---
title: "Functional Trait Models"
author: "Maggie Klope"
date: "10/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(ggridges)
library(stats)
library(sjPlot)
library(FD)
library(car)
library(DHARMa) #model diagnostics
library(glmmTMB) #model fitting
library(MuMIn) #model summaries and comparisons
library(emmeans) #post-hoc analyses
# library(performance) #for R2 values

# Loading 2019 abundance data calculated from transect surveys
abund_2019 <-  read_csv("Datasheets/2019_abundance_sci_names.csv") %>% 
  rename(species_name = Species) %>% #changing column names
  rename(climate = Climate) %>% #changing column names
  rename(treatment = Plot)#changing column names

abund_2019$climate[abund_2019$climate == "Int"] <- "Intermediate" #changing name of int climate

# Loading 2019 functional trait data (currently only has LA)
traits_19 <- read_csv("Datasheets/temp_2019_traits.csv") %>% 
  rename(old_names = Species) %>% #changing column names
  rename(Species = sci_name) %>% #changing column names
  dplyr::select(Climate, Treatment, Block, Species, Species_2, LA, functional_group) %>% 
  mutate(LA = as.numeric(LA)) %>% #making sure value is numeric
  mutate(Species = ifelse(Species == "Trifolium microcephalum", #fixing a typo that makes factors weird
                          "trifolium microcephalum",
                          Species)) %>%
  mutate(Treatment = ifelse(Treatment == "open", "Open", Treatment)) %>% #same thing, a typo
  drop_na() %>% 
  mutate(log_LA = log(LA))

abund_2019$climate[abund_2019$climate == "Int"] <- "Intermediate"#changing name of int climate

# Loading 2017 functional trait data
# traits_17 <- read_csv("final_traits_and_abundances.csv")

# TRY Database search to fill in missing species
# TRY_DB <- read_csv("Datasheets/TRY_DB_june_2020.csv") %>% 
#   filter(ValueKindName == c("Single", "Mean", "Best estimate")) %>% 
#   #unique() %>% 
#   dplyr::group_by(TraitName, AccSpeciesName) %>%
#   summarize(mean_value = mean(StdValue)) %>% 
#   rename(species_name = AccSpeciesName)

# write_csv(TRY_DB, "TRY_DB_summary.csv")

# reading in 2017 functional trait datasheet
md <- read_csv("Datasheets/MasterDataSheet(10_18_2020).csv") %>% 
  dplyr::select(climate, treatment, species_name, individual, wet_weight_g, wet_weight_mg, dry_weight_g, dry_weight_mg, Area_Leaf_total_mm2, Average_Leaf_Area) %>% 
  mutate(wet_weight_mg = as.numeric(wet_weight_mg)) %>% 
  mutate(wet_weight_g = as.numeric(wet_weight_g)) %>% 
  mutate(dry_weight_g = as.numeric(dry_weight_g)) %>% 
  mutate(dry_weight_mg = as.numeric(dry_weight_mg)) %>% 
  mutate(leaf_area = as.numeric(Average_Leaf_Area)) %>% 
  mutate(sla = Area_Leaf_total_mm2 / dry_weight_mg) %>% #computing sla
  mutate(ldmc = dry_weight_mg / wet_weight_g) #computing ldmc

#finding average values for 2017 from the masterdatasheet
traits_2017 <- md %>% 
  group_by(climate, treatment, species_name) %>% 
  summarise_all(mean, na.rm = TRUE)
#changing treatment names
traits_2017$treatment[traits_2017$treatment == "Cattle Exclosure"] <- "Partial"
traits_2017$treatment[traits_2017$treatment == "Control"] <- "Open"
traits_2017$treatment[traits_2017$treatment == "Full Exclosure"] <- "Total"
# changing climate names
traits_2017$climate[traits_2017$climate == "Semi-arid"] <- "Intermediate"

#need to rename some species to match 2019 abundance
traits_2017$species_name[traits_2017$species_name == "Trifolium microcephalum"] <- "Trifolium sp."
traits_2017$species_name[traits_2017$species_name == "lupinus bicolor?"] <- "Lupinus bicolor"
traits_2017$species_name[traits_2017$species_name == "Erodium cicutarium"] <- "Erodium sp."
traits_2017$species_name[traits_2017$species_name == "Erodium brachycarpum"] <- "Erodium sp."
traits_2017$species_name[traits_2017$species_name == "Ribes sp."] <- "Ribes californicum var. hesperium"
traits_2017$species_name[traits_2017$species_name == "Melica imperfecta"] <- "Melica californica"
traits_2017$species_name[traits_2017$species_name == "Plagiobothrys nothofulvus"] <- "Plagiobothrys sp."

#combining 2017 trait data with 2019 abundance data
cwm_traits <- abund_2019 %>% 
  group_by(climate, treatment) %>% 
  left_join(traits_2017, by = c("climate", "treatment", "species_name")) %>% 
  dplyr::select(climate, treatment, Block, species_name, Abundance, leaf_area, sla, ldmc, Notes)

other_traits <- read_csv("Datasheets/seed_mass_leaf_N.csv")

#data (updated) for Community-weighted means (CWMs)
cwm_traits_adj <-  read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  mutate(weighted_la = leaf_area * Abundance) %>% #multiplying trait values by species abundance
  mutate(weighted_sla = sla * Abundance) %>% 
  mutate(weighted_ldmc = ldmc * Abundance) %>%
  mutate(weighted_seed_mass = seed_mass * Abundance) %>%
  mutate(weighted_n = leaf_n * Abundance) %>%
  group_by(climate, treatment, Block) %>% #grouping by climate, treatment, and block
  summarise_all(mean, na.rm = TRUE) %>% #finding the mean
  dplyr::select(climate, treatment, Block, weighted_la, weighted_sla, weighted_ldmc, weighted_seed_mass, weighted_n)


```

## GLMs for individual species change

- Does not include block because I only have the mean for each species at each plot
- Some species are present in all climate/treatment, but some are not
- Based off of 2019 abundance data and 2019 trait collection data (LA, SLA, LDMC)

### Models:

**What is the effect of climate and grazing on individual species trait changes?**

`glm(trait ~ Climate * Treatment, family = gaussian)`

- planning to do for LA, SLA, and LDMC (from field collection in 2019) for a subset of species
- could do for seed mass and leaf N, but those values would be from TRY Database
- species chosen as those that are present across as many climate/treatment combinations as possible
- unfortunately, I scanned and weighed the leaves together to get averages, so I have lost the ability to add block to my models
- need to think of how I would deal with multiple comparisons (bonferroni correction?)

```{r}
#writing function to take species name and test model with dredge

model_test <- function(species_name, trait){
  temp_data <- traits_19[traits_19$Species == species_name,] %>% 
    drop_na()
  glm <- glm(data = temp_data, trait ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
  print(dredge(glm))
}

```

#### Bromus diandrus

Best fit: LA ~ 1
Next best: LA ~ climate

- treatment dropped from model
- no effect of climate

```{r}
bro_dia <- traits_19[traits_19$Species == "Bromus diandrus",] 


# model
glm_bro_dia <- glm(data = bro_dia , LA ~ Treatment * Climate, family = "gaussian", na.action = na.fail)
dredge(glm_bro_dia) # best fit model is null, second best includes only Climate

simulateResiduals(glm_bro_dia, plot= T) # looks good
shapiro.test(residuals(glm_bro_dia)) # normal

glm_bro_dia <- glm(data = bro_dia, LA ~ Climate, family = "gaussian", na.action = na.fail)

simulateResiduals(glm_bro_dia, plot= T) # looks good
shapiro.test(residuals(glm_bro_dia)) # but residuals are just normal

# post-hoc
emmeans(glm_bro_dia, pairwise ~ Climate)

bro_dia_la <- emmeans(glm_bro_dia, ~ Climate)
plot(bro_dia_la)

```

#### Festuca myuros

LA ~ Climate

- Arid > Intermediate; Arid > Mesic
- treatment dropped from model

```{r}
fes_myu <- traits_19[traits_19$Species == "Festuca myuros",]

glm_fes_myu <- glm(data = fes_myu, LA ~ Climate * Treatment,  family = gaussian, na.action = na.fail)
dredge(glm_fes_myu) # best fit climate only
glm_fes_myu <- glm(data = fes_myu, LA ~ Climate,  family = gaussian, na.action = na.fail)

simulateResiduals(glm_fes_myu, plot=T) # not good
shapiro.test(residuals(glm_fes_myu)) #not normal

# using log transformation
log_fes_myu <- glm(data = fes_myu, log_LA ~ Climate * Treatment,  family = gaussian, na.action = na.fail)
dredge(log_fes_myu) # best fit climate only
log_fes_myu <- glm(data = fes_myu, log_LA ~ Climate,  family = gaussian, na.action = na.fail)

simulateResiduals(log_fes_myu, plot=T)
shapiro.test(residuals(log_fes_myu)) #normal

# post-hoc testing
emmeans(log_fes_myu, pairwise ~ Climate)

fes_myu_la <- emmeans(log_fes_myu, ~ Climate)
plot(fes_myu_la)

```

#### Bromus hordeaceus

LA ~ Climate
- treatment dropped from model
- Arid > Int

```{r}
bro_ho <- traits_19[traits_19$Species == "Bromus hordeaceus",]

glm_bro_ho <- glm(data = bro_ho, LA ~ Climate * Treatment, family = gaussian, na.action = na.fail)
dredge(glm_bro_ho) # drops treatment
glm_bro_ho <- glm(data = bro_ho, LA ~ Climate, family = gaussian, na.action = na.fail)

simulateResiduals(glm_bro_ho, plot=T) # good
shapiro.test(residuals(glm_bro_ho)) # normal

# post-hoc
emmeans(glm_bro_ho, pairwise ~ Climate)

bro_ho_la <- emmeans(glm_bro_ho, ~ Climate)
plot(bro_ho_la)

```

#### Bromus tectorum

LA ~ 1

- best model is intercept only

```{r}
bro_tec <- traits_19[traits_19$Species == "Bromus tectorum",]

glm_bro_tec <- glm(data = bro_tec, LA ~ Climate * Treatment, family = gaussian, na.action = na.fail)
dredge(glm_bro_tec) # best model has intercept only

simulateResiduals(glm_bro_tec, plot=T) # good
shapiro.test(residuals(glm_bro_tec)) #normal

```

#### Hordeum murium

LA ~ Treatment

- climate dropped from model
- Total > Open

```{r}
hor_mur <- traits_19[traits_19$Species == "Hordeum murinum",]

glm_hor_mur <- glm(data = hor_mur, LA ~ Climate * Treatment, family = gaussian, na.action = na.fail)
dredge(glm_hor_mur) # best fit includes treatment only
glm_hor_mur <- glm(data = hor_mur, LA ~ Treatment, family = gaussian, na.action = na.fail)

# does data fit model?
simulateResiduals(glm_hor_mur, plot=T) 
shapiro.test(residuals(glm_hor_mur)) # residuals are normal

# post-hoc
emmeans(glm_hor_mur, pairwise ~ Treatment)

hor_mur_la <- emmeans(glm_hor_mur, ~ Treatment)
plot(hor_mur_la)

```

#### Erodium cicutarium

LA ~ 1

Next best is LA ~ climate, but no difference between climate treatments

```{r}

ero_cic <- traits_19[traits_19$Species == "Erodium cicutarium",]

glm_ero_cic <- glm(data = ero_cic, LA ~ Climate * Treatment, family = gaussian, na.action = na.fail)
dredge(glm_ero_cic) # best model includes intercept only, but model with climate also has similar AIC value
glm_ero_cic <- glm(data = ero_cic, LA ~ 1, family = gaussian, na.action = na.fail)

# does data fit model?
simulateResiduals(glm_ero_cic, plot=T) # good
shapiro.test(residuals(glm_hor_mur)) # normal

# trying second-best model
glm_ero_cic <- glm(data = ero_cic, LA ~ Climate, family = gaussian, na.action = na.fail)
simulateResiduals(glm_ero_cic, plot=T) # doesn't have enough data points?
shapiro.test(residuals(glm_hor_mur)) # normal

# post-hoc
emmeans(glm_ero_cic, pairwise ~ Climate)

ero_cic_la <- emmeans(glm_ero_cic, ~ Climate)
plot(ero_cic_la)

```

#### Galium aparine

- native forb

LA ~ Climate
- model drops treatment
- Nice gradient over climate
    - Arid > Int
    - Arid > Mesic
    - Int > Mesic

```{r}
gal_apa <- traits_19[traits_19$Species == "Galium aparine",]

# models
glm_gal_apa <- glm(data = gal_apa, LA ~ Climate * Treatment, family = gaussian, na.action = na.fail)
dredge(glm_gal_apa) #best model climate only
glm_gal_apa <- glm(data = gal_apa, LA ~ Climate, family = gaussian, na.action = na.fail)

simulateResiduals(glm_gal_apa, plot=T)
shapiro.test(residuals(glm_gal_apa)) # normal

# post-hoc testing
emmeans(glm_gal_apa, pairwise ~ Climate)

gal_apa_la <- emmeans(glm_gal_apa, ~ Climate)
plot(gal_apa_la, by = NULL, CIs = FALSE, comparisons = TRUE, horizontal = FALSE, colors = "black")

```

#### Plagiobothrys nothofulvus

- native forb

LA ~ 1
- log transformed
- best model is intercept only

```{r}
# Plagiobothrys nothofulvus (forb)
pla_not <- traits_19[traits_19$Species == "Plagiobothrys nothofulvus",]
            
glm_pla_not <- glm(data = pla_not, LA ~ Climate * Treatment, family = gaussian, na.action = na.fail)
dredge(glm_pla_not) # best model intercept only

simulateResiduals(glm_pla_not, plot=T) # residuals vs. predicted not good
shapiro.test(residuals(glm_pla_not)) # normal

# trying log transform
glm_pla_not <- glm(data = pla_not, log_LA ~ Climate * Treatment, family = gaussian, na.action = na.fail)
dredge(glm_pla_not) # best model intercept only

simulateResiduals(glm_pla_not, plot=T) # good
shapiro.test(residuals(glm_pla_not)) # normal

```

#### Ribes californicum var. hesperium

- shrub
- model includes climate * treatment
- Int > Mesic for Partial treatments
- Open < Partial at Intermediate
- Not enough data for other treatments at Int
- No difference in treatments at Mesic

```{r}
ribes <- traits_19[traits_19$Species == "Ribes californicum var. hesperium",] %>% 
                 drop_na()

glm_ribes <- glm(data = ribes, LA ~ Climate * Treatment, family = gaussian, na.action = na.fail)
dredge(glm_ribes)

simulateResiduals(glm_ribes, plot=T) # good
shapiro.test(residuals(glm_ribes)) # normal

emmeans(glm_ribes, pairwise ~ Climate | Treatment)
emmeans(glm_ribes, pairwise ~ Treatment | Climate)

```

#### Symphoricarpos_mollis

- shrub
- Only present at mesic
- Best model is intercept only

```{r}
sym_mol <- traits_19[traits_19$Species == "Symphoricarpos_mollis",] %>% 
                 drop_na()

glm_sym_mol <- glm(data = sym_mol, LA ~ Treatment, family = gaussian, na.action = na.fail) #only at Mesic climate
dredge(glm_sym_mol)
glm_sym_mol <- glm(data = sym_mol, LA ~ 1, family = gaussian, na.action = na.fail) #only at Mesic climate

simulateResiduals(glm_sym_mol, plot=T) #good
shapiro.test(residuals(glm_sym_mol)) # normal


```

#### Ericameria nauseosa

- shrub
- best model is intercept only

```{r}
eri_nau <- traits_19[traits_19$Species == "Ericameria nauseosa",] %>% 
  drop_na()

glm_eri_nau <- glm(data = eri_nau, LA ~ Climate * Treatment, family = gaussian, na.action = na.fail)
dredge(glm_eri_nau)

simulateResiduals(glm_eri_nau, plot=T) # good
shapiro.test(residuals(glm_eri_nau)) # normal

```

## By functional group

```{r}
funct_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  mutate(sqrt_LA = sqrt(LA))

unique(funct_LA$Species)

# finding counts per group
funct_LA %>% 
  group_by(Climate, Treatment, functional_group, Species) %>% 
  count()

ggplot(funct_LA, aes(x = LA)) +
  geom_histogram() +
  theme_bw()

ggplot(funct_LA, aes(x = log_LA)) +
  geom_histogram() +
  theme_bw()

ggplot(funct_LA, aes(x = sqrt_LA)) +
  geom_histogram() +
  theme_bw()

shapiro.test(funct_LA$log_LA)

shapiro.test(funct_LA$sqrt_LA)

```

### GLMMs

```{r}
# Ideal model on un-transformed data:
funct_glmm <- glmmTMB(data = funct_LA, LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = gaussian)
dredge(funct_glmm) # best model only climate
funct_glmm <- glmmTMB(data = funct_LA, LA ~ Climate + (1|Species), family = gaussian)

simulateResiduals(funct_glmm, plot= T) # not good
shapiro.test(residuals(funct_glmm)) # not normal

# Trying with log transformation:
funct_glmm <- glmmTMB(data = funct_LA, log_LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = gaussian)
dredge(funct_glmm)
funct_glmm <- glmmTMB(data = funct_LA, log_LA ~ Climate + (1|Species), family = gaussian)

simulateResiduals(funct_glmm, plot= T) # not good
shapiro.test(residuals(funct_glmm)) # not normal

# Trying Gamma family with un-transformed
funct_glmm <- glmmTMB(data = funct_LA, LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = Gamma(link = "log"))
dredge(funct_glmm)
funct_glmm <- glmmTMB(data = funct_LA, LA ~ Climate + (1|Species), family = Gamma(link = "log"))

simulateResiduals(funct_glmm, plot= T) # not good
shapiro.test(residuals(funct_glmm)) # not normal

# Trying gaussian with square root transform
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = gaussian)
dredge(funct_glmm) # best model only climate
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + (1|Species), family = gaussian)

simulateResiduals(funct_glmm, plot= T) # not good
shapiro.test(residuals(funct_glmm)) # not normal

# gamma with square root
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = Gamma(link = "sqrt"))
dredge(funct_glmm) # best model only climate
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + (1|Species), family = Gamma(link = "sqrt"))

simulateResiduals(funct_glmm, plot= T) # good
shapiro.test(residuals(funct_glmm)) # not normal

# gamma with square root
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = Gamma(link = "log"))
dredge(funct_glmm) # best model only climate
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + (1|Species), family = Gamma(link = "log"))

simulateResiduals(funct_glmm, plot= T) # good
shapiro.test(residuals(funct_glmm)) # not normal

```

### GLMs by group

```{r}
grass_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "grass") %>% 
  mutate(sqrt_LA = sqrt(LA))

shrub_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "shrub") %>% 
  mutate(sqrt_LA = sqrt(LA)) %>% 
  mutate(inv_LA = 1 / LA)

forb_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "forb") %>% 
  mutate(sqrt_LA = sqrt(LA)) %>% 
  mutate(inv_LA = 1 / LA)

shapiro.test(forb_LA$log_LA) #normal
shapiro.test(shrub_LA$log_LA) #not normal
shapiro.test(grass_LA$log_LA) #not normal
shapiro.test(shrub_LA$sqrt_LA) #not normal
shapiro.test(grass_LA$sqrt_LA) #normal
shapiro.test(shrub_LA$inv_LA) #not normal

# just impact of functional group
funct_glm <- glm(data = funct_LA, LA ~ functional_group, family = Gamma, na.action = na.fail)
dredge(funct_glm)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

emmeans(funct_glm, pairwise ~ functional_group)

# with climate, treatment, and functional group
funct_glm <- glm(data = funct_LA, LA ~ Climate * Treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_glm)
funct_glm <- glm(data = funct_LA, LA ~ Climate + functional_group, family = gaussian, na.action = na.fail)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

# log transform
funct_glm <- glm(data = funct_LA, log_LA ~ Climate * Treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_glm)
funct_glm <- glm(data = funct_LA, log_LA ~ Climate + functional_group, family = gaussian, na.action = na.fail)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

# gamma distribution
funct_glm <- glm(data = funct_LA, LA ~ Climate + Treatment + functional_group, family = Gamma, na.action = na.fail)
dredge(funct_glm)
funct_glm <- glm(data = funct_LA, LA ~ Climate + functional_group, family = Gamma, na.action = na.fail)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

# gamma with log link
funct_glm <- glm(data = funct_LA, LA ~ Climate + Treatment + functional_group, family = Gamma(link = log), na.action = na.fail)
dredge(funct_glm)
funct_glm <- glm(data = funct_LA, LA ~ Climate + functional_group, family = Gamma(link = log), na.action = na.fail)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

#random effect with gaussian
funct_glm <- glm(data = funct_LA, LA ~ Climate + Treatment + functional_group + (1|fact_Species), family = "gaussian")


```


```{r}

grass_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "grass") %>% 
  mutate(sqrt_LA = sqrt(LA))

grass_LA

grass_glm <- glm(data = grass_LA, LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, LA ~ 1, family = "gaussian", na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

grass_glm <- glm(data = grass_LA, log_LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, log_LA ~ 1, family = "gaussian", na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

ggplot(grass_LA, aes(x = LA)) +
  geom_histogram() +
  theme_bw()

grass_glm <- glm(data = grass_LA, LA ~ Climate + Treatment, family = Gamma, na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, LA ~ 1, family = Gamma, na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

grass_glm <- glm(data = grass_LA, log_LA ~ Climate + Treatment, family = Gamma, na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, log_LA ~ 1, family = Gamma, na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

grass_glm <- glm(data = grass_LA, LA ~ Climate + Treatment, family = Gamma(link = log), na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, LA ~ 1, family = Gamma(link=log), na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

grass_glm <- glm(data = grass_LA, sqrt_LA ~ Climate + Treatment, family = gaussian, na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, sqrt_LA ~ 1, family = gaussian, na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # normal


```


```{r}
shrub_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "shrub") %>% 
  mutate(sqrt_LA = sqrt(LA)) %>% 
  mutate(inv_LA = 1 / LA)

shrub_glm <- glm(data = shrub_LA, LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
boxCox(shrub_glm)

shrub_glm <- glm(data = shrub_LA, LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, LA ~ Climate, family = "gaussian", na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

shrub_glm <- glm(data = shrub_LA, log_LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, log_LA ~ Climate, family = "gaussian", na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

ggplot(shrub_LA, aes(x = LA)) +
  geom_histogram(bins = 100) +
  theme_bw()

ggplot(shrub_LA, aes(x = log_LA)) +
  geom_histogram(bins=100) +
  theme_bw()

ggplot(shrub_LA, aes(x = inv_LA)) +
  geom_histogram(bins=100) +
  theme_bw()


shrub_glm <- glm(data = shrub_LA, LA ~ Climate + Treatment, family = Gamma, na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, LA ~ Climate, family = Gamma, na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

shrub_glm <- glm(data = shrub_LA, log_LA ~ Climate + Treatment, family = Gamma, na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, log_LA ~ Climate, family = Gamma, na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

shrub_glm <- glm(data = shrub_LA, LA ~ Climate + Treatment, family = Gamma(link = log), na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, LA ~ Climate, family = Gamma(link=log), na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

shrub_glm <- glm(data = shrub_LA, sqrt_LA ~ Climate + Treatment, family = gaussian, na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, sqrt_LA ~ Climate, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # normal

shrub_glm <- glm(data = shrub_LA, inv_LA ~ Climate + Treatment, family = gaussian, na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, inv_LA ~ Climate, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # normal

```


```{r}
# # TRY Database search to fill in missing species
# TRY_DB_1 <- read_csv("Datasheets/TRY_DB_june_2020.csv") %>% 
#   filter(ValueKindName %in% c("Single", "Mean", "Best estimate")) %>%
#   dplyr::select(AccSpeciesName, TraitName, StdValue) %>% 
#   dplyr::group_by(AccSpeciesName, TraitName) %>% 
#   mutate(StdValue = as.numeric(StdValue)) %>% 
#   summarize(mean = mean(StdValue)) %>% 
#   rename(species_name = AccSpeciesName)
# 
# TRY_DB_2 <- read_csv("Datasheets/TRY_DB_Oct-18-20.csv") %>% 
#   filter(ValueKindName %in% c("Single", "Mean", "Best estimate")) %>%
#   dplyr::select(AccSpeciesName, TraitName, StdValue) %>% 
#   dplyr::group_by(AccSpeciesName, TraitName) %>% 
#   mutate(StdValue = as.numeric(StdValue)) %>% 
#   summarize(mean = mean(StdValue)) %>% 
#   rename(species_name = AccSpeciesName)
# 
# write.csv(TRY_DB_2, "TRY_DB_2.csv")

```

