---
title: "Functional_Diversity"
author: "Maggie Klope"
date: "10/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(stats)
library(sjPlot)
library(FD)
library(DHARMa) #model diagnostics
library(glmmTMB) #model fitting
library(MuMIn) #model summaries and comparisons
library(emmeans) #post-hoc analyses
# library(performance) #for R2 values
```

```{r tidy data, include=FALSE}
other_traits <- read_csv("Datasheets/seed_mass_leaf_N.csv")

#making a df just for functional diveristy calculations
for_FD <- read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  select(climate, treatment, Block, species_name, Abundance, leaf_area, sla, ldmc, seed_mass, leaf_n) %>% 
  drop_na

#abundance data in correct format:
fd_abund <- function(Climate, Treatment){
  as.matrix(for_FD %>% 
    filter(climate == Climate) %>% 
    filter(treatment == Treatment) %>% 
    arrange(species_name) %>% 
    select(Block, species_name, Abundance) %>%
    pivot_wider(names_from = species_name, values_from = Abundance) %>%
    replace(is.na(.), 0) %>% 
    column_to_rownames(var = "Block"))
}

arid_open_abund <- fd_abund("Arid", "Open")
arid_partial_abund <- fd_abund("Arid", "Partial")
arid_total_abund  <- fd_abund("Arid", "Total")

int_open_abund <- fd_abund("Intermediate", "Open")
int_partial_abund <- fd_abund("Intermediate", "Partial")
int_total_abund <- fd_abund("Intermediate", "Total")

mesic_open_abund <- fd_abund("Mesic", "Open")
mesic_partial_abund <- fd_abund("Mesic", "Partial")
mesic_total_abund <- fd_abund("Mesic", "Total")

# trait data in correct format:

fd_traits <- function(Climate, Treatment, fd_abund_data){
  for_FD %>% 
    ungroup(climate, treatment) %>% 
    filter(climate == Climate) %>% 
    filter(treatment == Treatment) %>% 
    select(species_name, leaf_area, sla, ldmc) %>% 
    distinct() %>% 
    arrange(species_name) %>% 
    column_to_rownames(var = "species_name") 
  
}

arid_open_trait <- fd_traits("Arid", "Open", arid_open_abund)
arid_partial_trait <- fd_traits("Arid", "Partial", arid_partial_abund)
arid_total_trait <- fd_traits("Arid", "Total", arid_total_abund)

int_open_trait <- fd_traits("Intermediate", "Open", int_open_abund)
int_partial_trait <- fd_traits("Intermediate", "Partial", int_partial_abund)
int_total_trait <- fd_traits("Intermediate", "Total", int_total_abund)

mesic_open_trait <- fd_traits("Mesic", "Open", mesic_open_abund)
mesic_partial_trait <- fd_traits("Mesic", "Partial", mesic_partial_abund)
mesic_total_trait <- fd_traits("Mesic", "Total", mesic_total_abund)

```

```{r FD calcs, include=FALSE}
arid_open_fd <- dbFD(x = arid_open_trait, a = arid_open_abund)
arid_partial_fd <- dbFD(x = arid_partial_trait, a = arid_partial_abund)
arid_total_fd <- dbFD(x = arid_total_trait, a = arid_total_abund)

int_open_fd <- dbFD(x = int_open_trait, a = int_open_abund)
int_partial_fd <- dbFD(x = int_partial_trait, a = int_partial_abund)
int_total_fd <- dbFD(x = int_total_trait, a = int_total_abund)

mesic_open_fd <- dbFD(x = mesic_open_trait, a = mesic_open_abund)
mesic_partial_fd <- dbFD(x = mesic_partial_trait, a = mesic_partial_abund)
mesic_total_fd <- dbFD(x = mesic_total_trait, a = mesic_total_abund)

FD_arid_open <- as.data.frame(arid_open_fd$FRic) %>% 
  rownames_to_column() %>% 
  rename(FRic = "arid_open_fd$FRic") %>% 
  rename(Block = "rowname") %>% 
  mutate(climate = "Arid") %>% 
  mutate(treatment = "Open") %>% 
  mutate(FEve = arid_open_fd$FEve) %>% 
  mutate(FDiv = arid_open_fd$FDiv) %>% 
  mutate(FDis = arid_open_fd$FDis) %>% 
  mutate(RaoQ = arid_open_fd$RaoQ)
  
FD_arid_partial <- as.data.frame(arid_partial_fd$FRic) %>% 
  rownames_to_column() %>% 
  rename(FRic = "arid_partial_fd$FRic") %>% 
  rename(Block = "rowname") %>% 
  mutate(climate = "Arid") %>% 
  mutate(treatment = "Partial")%>% 
  mutate(FEve = arid_partial_fd$FEve) %>% 
  mutate(FDiv = arid_partial_fd$FDiv) %>% 
  mutate(FDis = arid_partial_fd$FDis) %>% 
  mutate(RaoQ = arid_partial_fd$RaoQ)

FD_arid_total <- as.data.frame(arid_total_fd$FRic) %>% 
  rownames_to_column() %>% 
  rename(FRic = "arid_total_fd$FRic") %>% 
  rename(Block = "rowname") %>% 
  mutate(climate = "Arid") %>% 
  mutate(treatment = "Total")%>% 
  mutate(FEve = arid_total_fd$FEve) %>% 
  mutate(FDiv = arid_total_fd$FDiv) %>% 
  mutate(FDis = arid_total_fd$FDis) %>% 
  mutate(RaoQ = arid_total_fd$RaoQ)

FD_int_open <- as.data.frame(int_open_fd$FRic) %>% 
  rownames_to_column() %>% 
  rename(FRic = "int_open_fd$FRic") %>% 
  rename(Block = "rowname") %>% 
  mutate(climate = "Intermediate") %>% 
  mutate(treatment = "Open")%>% 
  mutate(FEve = int_open_fd$FEve) %>% 
  mutate(FDiv = int_open_fd$FDiv) %>% 
  mutate(FDis = int_open_fd$FDis) %>% 
  mutate(RaoQ = int_open_fd$RaoQ)

FD_int_partial <- as.data.frame(int_partial_fd$FRic) %>% 
  rownames_to_column() %>% 
  rename(FRic = "int_partial_fd$FRic") %>% 
  rename(Block = "rowname") %>% 
  mutate(climate = "Intermediate") %>% 
  mutate(treatment = "Partial")%>% 
  mutate(FEve = int_partial_fd$FEve) %>% 
  mutate(FDiv = int_partial_fd$FDiv) %>% 
  mutate(FDis = int_partial_fd$FDis) %>% 
  mutate(RaoQ = int_partial_fd$RaoQ)

FD_int_total <- as.data.frame(int_total_fd$FRic) %>% 
  rownames_to_column() %>% 
  rename(FRic = "int_total_fd$FRic") %>% 
  rename(Block = "rowname") %>% 
  mutate(climate = "Intermediate") %>% 
  mutate(treatment = "Total")%>% 
  mutate(FEve = int_total_fd$FEve) %>% 
  mutate(FDiv = int_total_fd$FDiv) %>% 
  mutate(FDis = int_total_fd$FDis) %>% 
  mutate(RaoQ = int_total_fd$RaoQ)

FD_mesic_open <- as.data.frame(mesic_open_fd$FRic) %>% 
  rownames_to_column() %>% 
  rename(FRic = "mesic_open_fd$FRic") %>% 
  rename(Block = "rowname") %>% 
  mutate(climate = "Mesic") %>% 
  mutate(treatment = "Open")%>% 
  mutate(FEve = mesic_open_fd$FEve) %>% 
  mutate(FDiv = mesic_open_fd$FDiv) %>% 
  mutate(FDis = mesic_open_fd$FDis) %>% 
  mutate(RaoQ = mesic_open_fd$RaoQ)

FD_mesic_partial <- as.data.frame(mesic_partial_fd$FRic) %>% 
  rownames_to_column() %>% 
  rename(FRic = "mesic_partial_fd$FRic") %>% 
  rename(Block = "rowname") %>% 
  mutate(climate = "Mesic") %>% 
  mutate(treatment = "Partial") %>% 
  mutate(FEve = mesic_partial_fd$FEve) %>% 
  mutate(FDiv = mesic_partial_fd$FDiv) %>% 
  mutate(FDis = mesic_partial_fd$FDis) %>% 
  mutate(RaoQ = mesic_partial_fd$RaoQ)

FD_mesic_total <- as.data.frame(mesic_total_fd$FRic) %>% 
  rownames_to_column() %>% 
  rename(FRic = "mesic_total_fd$FRic") %>% 
  rename(Block = "rowname") %>% 
  mutate(climate = "Mesic") %>% 
  mutate(treatment = "Total")%>% 
  mutate(FEve = mesic_total_fd$FEve) %>% 
  mutate(FDiv = mesic_total_fd$FDiv) %>% 
  mutate(FDis = mesic_total_fd$FDis) %>% 
  mutate(RaoQ = mesic_total_fd$RaoQ)

FD_all <- rbind(FD_arid_open, FD_arid_partial, FD_arid_total, FD_int_open, FD_int_partial, FD_int_total, FD_mesic_open, FD_mesic_partial, FD_mesic_total)
```

```{r}
FD_all %>%
  pivot_longer(cols = c(FRic, FEve:FDis),
               names_to = "FD",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_wrap(~FD, scales = "free")

```

### Models

#### FRic

- averaged over treatment, there is a sig difference between Arid-Int and Int-Mesic, but not Arid-Mesic
- averaged over climate, there is not sig difference between treatments
- Arid
    - Arid Partial > Arid Open
    - Arid Partial > Arid Total
    - No difference between Arid Open and Arid Total
- Int
    - No difference between herbivore treatments at int
- Mesic
  - Mesic Open > Mesic Total
- Open
    - Mesic Open > Arid Open 
    - Mesic Open > Int Open
    - no diff between arid open and int open
- Partial
    - Arid Partial > Intermediate Partial
    - Arid Partial > Mesic Partial
    - No difference between int partial and mesic partial
- Total
    -No difference between climates for total exclosure
    
```{r}
FRic <- glm(data = FD_all, FRic ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(FRic) #best model: FRic ~ climate * treatment

# does data fit model?
simulateResiduals(FRic, plot=T) # looks ok
shapiro.test(residuals(FRic)) # residuals are normal

# significatn pairs
FRic_sig_pairs <-  as.data.frame(pairs(emmeans(FRic, ~ climate * treatment)))%>% 
  filter(p.value <= 0.05)

# all pairwise comparisons
emmeans(FRic, pairwise ~ climate)
emmeans(FRic, pairwise ~ treatment)
# emmeans(FRic, pairwise ~ climate * treatment)
emmeans(FRic, pairwise ~ climate | treatment)

```

#### FEve

- best fit model is intercept only
- next best model includes climate, but there is no significance
- I checked model fit and data distribution, and it all looked good

```{r}
FEve <- glm(data = FD_all, FEve ~ climate * treatment, family = gaussian, na.action = na.pass)
dredge(FEve) #best model includes only the intercept, going forward with testing for fit to make sure I'm using correct family
FEve <- glm(data = FD_all, FEve ~ 1, family = gaussian, na.action = na.fail)

# does data fit model?
simulateResiduals(FEve, plot=T) # good
shapiro.test(residuals(FEve)) # residuals are normal

ggplot(FD_all, aes(x = FEve)) +
  geom_histogram() +
  theme_bw()

shapiro.test(FD_all$FEve) #data is normal

# next best model:
FEve <- glm(data = FD_all, FEve ~ treatment, family = gaussian, na.action = na.fail)

# does data fit model?
simulateResiduals(FEve, plot=T) # good
shapiro.test(residuals(FEve)) # residuals are normal

# all pairwise comparisons
emmeans(FEve, pairwise ~ treatment) #no significance between treatments

```

#### FDiv

- averaged over climate levels, there is a sig difference between all climate treatments
- averaged over herbivore treatment, there is a sig difference between Arid-Mesic and Int-Mesic
- Arid
    - Arid Open > Arid Partial
    - Arid Total > Arid Open
    - Arid Total > Arid Partial
- Int
    - Int Open > Int Partial
    - Int Total > Int Open
    - Int Total > Int Partial
- Mesic
    - No difference in treatment at mesic
- Open
    - No difference between climates for open treatments
- Partial
    - Mesic Partial > Arid Partial
    - Mesic Partial > Int Partial
    - No difference in int partial and arid partial
-Total
    - No difference between climates for total exclosure

```{r}
FDiv <- glm(data = FD_all, FDiv ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(FDiv) #best model: FDiv ~ climate * treatment

# does data fit model?
simulateResiduals(FDiv, plot=T) # looks ok
shapiro.test(residuals(FDiv)) # residuals are  normal

# significant pairs
FDiv_sig_pairs <-  as.data.frame(pairs(emmeans(FDiv, ~ climate * treatment)))%>% 
  filter(p.value <= 0.05)

# all pairwise comparisons
emmeans(FDiv, pairwise ~ climate)
emmeans(FDiv, pairwise ~ treatment)
# emmeans(FDiv, pairwise ~ climate * treatment)
emmeans(FDiv, pairwise ~ climate | treatment)
```

#### FDis

- Averaged over treatment, sig difference between Arid-Mesic and Int-Mesic
- Averaged over climate, sig difference between Open-Partial and Open-Total, but not Open-Partial
- Arid
    - Arid Total > Arid Open
    - Arid Total > Arid Partial
    - No difference between Open and Partial
- Int
    - Int Total > Int Open
    - Int Total > Int Partial
    - No difference between Open and Partial
- Mesic
    - Mesic Open > Mesic Partial
    - No dif between Total-Open
    - No dif between Total-Partial
- Open
    - Mesic Open > Arid Open
    - Mesic Open > Int Open
    - No differecne for Arid-Int
- Partial
    - Mesic Partial > Arid Partial
    - Mesic Partial > Int Partial
      - No differecne for Arid-Int
- Total
    - Int Total > Arid Total
    - Int Total > Mesic Total
    - No difference between Mesic-Arid
    
```{r}
FDis <- glm(data = FD_all, FDis ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(FDis) #best model: FDis ~ climate * treatment

# does data fit model?
simulateResiduals(FDis, plot=T) # looks ok
shapiro.test(residuals(FDis)) # residuals are normal

# significatn pairs
FDis_sig_pairs <-  as.data.frame(pairs(emmeans(FDis, ~ climate * treatment)))%>% 
  filter(p.value <= 0.05)

# all pairwise comparisons
emmeans(FDis, pairwise ~ climate)
emmeans(FDis, pairwise ~ treatment)
# emmeans(FDis, pairwise ~ climate * treatment)
emmeans(FDis, pairwise ~ climate | treatment)

```


```{r RaoQ, include=FALSE}
RaoQ <- glmmTMB(data = FD_all, RaoQ ~ climate * treatment, family = gaussian)
dredge(RaoQ) #best model: RaoQ ~ climate * treatment

# does data fit model?
simulateResiduals(RaoQ, plot=T) # Looks like there is a weird pattern
shapiro.test(residuals(RaoQ)) # but residuals are normal

#significatn pairs
RaoQ_sig_pairs <-  as.data.frame(pairs(emmeans(RaoQ, ~ climate * treatment)))%>% 
  filter(p.value <= 0.05)

#all pairs
emmeans(RaoQ, pairwise ~ climate * treatment)

```
