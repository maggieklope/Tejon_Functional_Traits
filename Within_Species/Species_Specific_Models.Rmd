---
title: "Functional Trait Models"
author: "Maggie Klope"
date: "10/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(ggridges)
library(stats)
library(sjPlot)
library(FD)
library(car)
library(DHARMa) #model diagnostics
library(glmmTMB) #model fitting
library(MuMIn) #model summaries and comparisons
library(emmeans) #post-hoc analyses
# library(performance) #for R2 values

# Loading 2019 abundance data calculated from transect surveys
abund_2019 <-  read_csv("Datasheets/2019_abundance_sci_names.csv") %>% 
  rename(species_name = Species) %>% # changing column names
  rename(climate = Climate) %>% # changing column names
  rename(treatment = Plot)# changing column names

abund_2019$climate[abund_2019$climate == "Int"] <- "Intermediate" # changing name of int climate

# Loading 2019 functional trait data (currently only has LA)
traits_19 <- read_csv("Datasheets/temp_2019_traits.csv") %>% 
  rename(old_names = Species) %>% # changing column names
  rename(Species = sci_name) %>% # changing column names
  dplyr::select(Climate, Treatment, Block, Species, Species_2, LA, functional_group) %>% 
  mutate(LA = as.numeric(LA)) %>% # making sure value is numeric
  mutate(Species = ifelse(Species == "Trifolium microcephalum", #fixing a typo that makes factors weird
                          "trifolium microcephalum",
                          Species)) %>%
  mutate(Treatment = ifelse(Treatment == "open", "Open", Treatment)) %>% #same thing, a typo
  drop_na() %>% 
  mutate(log_LA = log(LA))

abund_2019$climate[abund_2019$climate == "Int"] <- "Intermediate"#changing name of int climate

# Loading 2017 functional trait data
# traits_17 <- read_csv("final_traits_and_abundances.csv")

# TRY Database search to fill in missing species
# TRY_DB <- read_csv("Datasheets/TRY_DB_june_2020.csv") %>% 
#   filter(ValueKindName == c("Single", "Mean", "Best estimate")) %>% 
#   #unique() %>% 
#   dplyr::group_by(TraitName, AccSpeciesName) %>%
#   summarize(mean_value = mean(StdValue)) %>% 
#   rename(species_name = AccSpeciesName)

# write_csv(TRY_DB, "TRY_DB_summary.csv")

# reading in 2017 functional trait datasheet
md <- read_csv("Datasheets/MasterDataSheet(10_18_2020).csv") %>% 
  dplyr::select(climate, treatment, species_name, individual, wet_weight_g, wet_weight_mg, dry_weight_g, dry_weight_mg, Area_Leaf_total_mm2, Average_Leaf_Area) %>% 
  mutate(wet_weight_mg = as.numeric(wet_weight_mg)) %>% 
  mutate(wet_weight_g = as.numeric(wet_weight_g)) %>% 
  mutate(dry_weight_g = as.numeric(dry_weight_g)) %>% 
  mutate(dry_weight_mg = as.numeric(dry_weight_mg)) %>% 
  mutate(leaf_area = as.numeric(Average_Leaf_Area)) %>% 
  mutate(sla = Area_Leaf_total_mm2 / dry_weight_mg) %>% #computing sla
  mutate(ldmc = dry_weight_mg / wet_weight_g) #computing ldmc

#finding average values for 2017 from the masterdatasheet
traits_2017 <- md %>% 
  group_by(climate, treatment, species_name) %>% 
  summarise_all(mean, na.rm = TRUE)
#changing treatment names
traits_2017$treatment[traits_2017$treatment == "Cattle Exclosure"] <- "Partial"
traits_2017$treatment[traits_2017$treatment == "Control"] <- "Open"
traits_2017$treatment[traits_2017$treatment == "Full Exclosure"] <- "Total"
# changing climate names
traits_2017$climate[traits_2017$climate == "Semi-arid"] <- "Intermediate"

#need to rename some species to match 2019 abundance
traits_2017$species_name[traits_2017$species_name == "Trifolium microcephalum"] <- "Trifolium sp."
traits_2017$species_name[traits_2017$species_name == "lupinus bicolor?"] <- "Lupinus bicolor"
traits_2017$species_name[traits_2017$species_name == "Erodium cicutarium"] <- "Erodium sp."
traits_2017$species_name[traits_2017$species_name == "Erodium brachycarpum"] <- "Erodium sp."
traits_2017$species_name[traits_2017$species_name == "Ribes sp."] <- "Ribes californicum var. hesperium"
traits_2017$species_name[traits_2017$species_name == "Melica imperfecta"] <- "Melica californica"
traits_2017$species_name[traits_2017$species_name == "Plagiobothrys nothofulvus"] <- "Plagiobothrys sp."

#combining 2017 trait data with 2019 abundance data
cwm_traits <- abund_2019 %>% 
  group_by(climate, treatment) %>% 
  left_join(traits_2017, by = c("climate", "treatment", "species_name")) %>% 
  dplyr::select(climate, treatment, Block, species_name, Abundance, leaf_area, sla, ldmc, Notes)

other_traits <- read_csv("Datasheets/seed_mass_leaf_N.csv")

#data (updated) for Community-weighted means (CWMs)
cwm_traits_adj <-  read_csv("Datasheets/cwm_traits_updated.csv") %>% 
  left_join(other_traits, by = "species_name") %>% 
  mutate(weighted_la = leaf_area * Abundance) %>% #multiplying trait values by species abundance
  mutate(weighted_sla = sla * Abundance) %>% 
  mutate(weighted_ldmc = ldmc * Abundance) %>%
  mutate(weighted_seed_mass = seed_mass * Abundance) %>%
  mutate(weighted_n = leaf_n * Abundance) %>%
  group_by(climate, treatment, Block) %>% #grouping by climate, treatment, and block
  summarise_all(mean, na.rm = TRUE) %>% #finding the mean
  dplyr::select(climate, treatment, Block, weighted_la, weighted_sla, weighted_ldmc, weighted_seed_mass, weighted_n)


```

# Uploading New Data
```{r}
# read in data
new_block_names <- read_csv("/Users/User_2/github/Tejon_Functional_Traits/Datasheets/new_block_names.csv") %>% 
  mutate(block = as.character(block))

la_2019 <- read_csv("/Users/User_2/github/Tejon_Functional_Traits/Datasheets/leaf_area_2019.csv") %>%
  mutate(block = as.character(block)) %>% 
  dplyr::select(climate, block, treatment, species, area) %>%
  mutate(climate = ifelse(climate == "Aird", "Arid", climate)) %>% 
  mutate(climate = ifelse(climate == "intermediate", "Intermediate", climate)) %>% 
  mutate(species = ifelse(species == "Tridilea", "Triteleia ixioides", species)) %>% 
  mutate(species = ifelse(species == "Cheatgrass" | species == "cheatgrass", "Bromus tectorum", species)) %>% 
  mutate(species = ifelse(species == "Popcorn flower" | species == "popcorn flower", "Plagiobothrys nothofulvus", species)) %>% 
  mutate(species = ifelse(species == "Foxtail", "Hordeum murium", species)) %>% 
  mutate(species = ifelse(species == "Clover" | species == "Trifolium", "Trifolium microcephalum", species)) %>% 
  mutate(species = ifelse(species == "Bedstraw" | species == "bedstraw" | species == "Bestraw" | species == "bestraw", "Galium aparine", species)) %>% 
  mutate(species = ifelse(species == "J" | species == "Bromus hordeaceous", "Bromus hordeaceus", species)) %>% 
  mutate(species = ifelse(species == "Erodium" | species == "erodium" | species == "Erodium circularium", "Erodium cicutarium", species)) %>% 
  mutate(species = ifelse(species == "festuca myuros", "Festuca myuros", species)) %>% 
  mutate(species = ifelse(species == "Gooseberry", "Ribes", species)) %>% 
  mutate(species = ifelse(species == "Snowberry", "Symphoricarpos mollis", species)) %>% 
  mutate(species = ifelse(species == "Rabbit Brush", "Ericameria nauseosa", species)) %>% 
  mutate(species = ifelse(species == "Bromus Diandrus", "Bromus diandrus", species)) %>% 
  mutate(treatment = ifelse(treatment == "Control"|
                              treatment == "OPEN", "Open", treatment)) %>% 
  mutate(treatment = ifelse(treatment == "Full"|
                              treatment == "Tota", "Total", treatment)) %>% 
  group_by(climate, block, treatment, species) %>% 
  summarise_at(vars(area), .fun = sum) %>%
   mutate(block = ifelse(block == "B1", "1", 
                        ifelse(block == "B2", "2",
                               ifelse(block == "B3", "3", block)))) %>%
  left_join(new_block_names, by = c("climate", "block"))
  
# la_2019 %>% 
#   group_by(climate, new_block, treatment, species) %>% 
#   filter(n()>1)

```

```{r}
dry_2019 <- read_csv("/Users/User_2/github/Tejon_Functional_Traits/Datasheets/dry_weights_2019.csv") %>% 
  mutate(climate = ifelse(climate == "M", "Mesic", 
                          ifelse(climate == "Int", "Intermediate", climate))) %>% 
  mutate(block = ifelse(block == "B1", "1", 
                        ifelse(block == "B2", "2",
                               ifelse(block == "B3", "3", block)))) %>%
  mutate(block = as.character(block)) %>% 
  left_join(new_block_names, by = c("climate", "block")) %>% 
  mutate(species = ifelse(species == "Gooseberry", "Ribes", species)) %>% 
  mutate(species = ifelse(species == "Bromus hord." |
                            species == "Bromus hord" |
                            species == "J-Bromus hordeaceus" |
                            species == "J" |
                            species == "Bromus hordeaceus J", "Bromus hordeaceus", species)) %>% 
  mutate(species = ifelse(species == "Rabbit brush", "Ericameria nauseosa", species)) %>% 
  mutate(species = ifelse(species == "Snowberry", "Symphoricarpos mollis", species)) %>% 
  mutate(species = ifelse(species == "Tridilea", "Triteleia ixioides", species)) %>% 
  mutate(species = ifelse(species == "Brodi", "Bromus diandrus", species)) %>% 
  mutate(species = ifelse(species == "tectorum" |
                            species == "Cheatgrass", "Bromus tectorum", species)) %>% 
  mutate(species = ifelse(species == "Clover" | 
                            species == "Trifolium" |
                            species == "Clover-trifolium", "Trifolium microcephalum", species)) %>% 
   mutate(species = ifelse(species == "Erodium" | 
                             species == "Erodium c.", "Erodium cicutarium", species)) %>% 
  mutate(species = ifelse(species == "Festuca m" |
                            species == "Festuca", "Festuca myuros", species)) %>% 
  mutate(species = ifelse(species == "Foxtail", "Hordeum murinum", species)) %>% 
  mutate(species = ifelse(species == "Bedstraw", "Galium aparine", species)) %>% 
  mutate(species = ifelse(species == "Popcorn flower", "Plagiobothrys nothofulvus", species)) %>% 
  mutate(species = ifelse(species == "N/A", NA, species)) %>% 
  mutate(treatment = ifelse(treatment == "open"|
                              treatment == "control", "Open", treatment)) %>% 
  mutate(treatment = ifelse(treatment == "partial", "Partial", treatment)) %>% 
  mutate(treatment = ifelse(treatment == "full" |
                              treatment == "total", "Total", treatment)) %>% 
  rename(dry_weight_g = weight_g) %>% 
  group_by(climate, new_block, treatment, species) %>% 
  summarise_at(vars(dry_weight_g), .fun = sum)

dry_2019
```

```{r}
wet_2019 <- read_csv("/Users/User_2/github/Tejon_Functional_Traits/Datasheets/wet_weights_2019.csv") %>%
   mutate(treatment = ifelse(treatment == "open"|
                              treatment == "control"|
                               treatment == "Control", "Open", treatment)) %>% 
  mutate(treatment = ifelse(treatment == "partial", "Partial", treatment)) %>% 
  mutate(treatment = ifelse(treatment == "full" |
                              treatment == "total"|
                              treatment == "Full", "Total", treatment)) %>% 
  mutate(block = as.character(block)) %>% 
  left_join(new_block_names, by = c("climate", "block")) %>% 
  mutate(species = ifelse(species == "Tridilea", "Triteleia ixioides", species)) %>% 
  mutate(species = ifelse(species == "Popcorn flower" | species == "Popcorn Flower", "Plagiobothrys nothofulvus", species)) %>% 
  mutate(species = ifelse(species == "Clover" | 
                            species == "Trifolium" |
                            species == "clover" |
                            species == "Triflolium" |
                            species == "trifolium", "Trifolium microcephalum", species)) %>% 
  mutate(species = ifelse(species == "Cheatgrass", "Bromus tectorum", species)) %>% 
  mutate(species = ifelse(species == "Gooseberry", "Ribes", species)) %>% 
  mutate(species = ifelse(species == "Snowberry"|
                            species == "snowberry", "Symphoricarpos mollis", species)) %>% 
  mutate(species = ifelse(species == "bromus diandrus" |
                            species == "Bromus dian" |
                            species == "bromus dian", "Bromus diandrus", species)) %>% 
  mutate(species = ifelse(species == "Foxtail"|
                            species == "foxtail"|
                            species == "Hordium murium", "Hordeum murinum", species)) %>% 
  mutate(species = ifelse(species == "Bedstraw"|
                            species == "bedstraw"|
                            species == "Bestraw", "Galium aparine", species)) %>% 
  mutate(species = ifelse(species == "rabbit brush"|
                            species == "Rabbit Brush" |
                            species == "rabbit Brush", "Ericameria nauseosa", species)) %>% 
  mutate(species = ifelse(species == "J", "Bromus hordeaceus", species)) %>% 
  mutate(species = ifelse(species == "cheatgrass", "Bromus tectorum", species)) %>% 
  mutate(species = ifelse(species == "festuca myuros", "Festuca myuros", species)) %>% 
  rename(wet_weight_g = weight_g)

```

```{r}
full_join_2019 <- la_2019 %>% 
  mutate(species = ifelse(species == "Bromus diandus", "Bromus diandrus", species)) %>% 
  mutate(species = ifelse(species == "Hordeum mirium"|
                            species == "Hordeum murium", "Hordeum murinum", species)) %>% 
  full_join(dry_2019, by = c("climate", "new_block", "treatment", "species"), keep = FALSE) %>% 
  full_join(wet_2019, by = c("climate", "new_block", "treatment", "species"), keep = FALSE) %>% 
  # removing duplicates that I can't fix
  filter(!(climate == "Arid" & new_block == "A" & treatment == "Partial" & species == "Triteleia ixioides")) %>%
  filter(!(climate == "Arid" & new_block == "A" & treatment == "Open" & species == "Galium aparine")) %>%
  filter(!(climate == "Intermediate" & new_block == "D" & treatment == "Partial" & species == "Bromus diandrus")) %>%
  filter(!(climate == "Mesic" & new_block == "G" & treatment == "Partial" & species == "Bromus diandrus"))

traits_2019 <- full_join_2019 %>% 
  dplyr::select(climate, block.x, block.y, new_block, treatment, species, num_leaves, num_indivs, area, wet_weight_g, dry_weight_g) %>% 
  mutate(dry_weight_mg = dry_weight_g * 1000) %>% 
  mutate(indiv_area = as.numeric(area) / as.numeric(num_leaves)) %>%
  mutate(sla = as.numeric(area) / dry_weight_mg) %>% 
  mutate(ldmc = dry_weight_mg / as.numeric(wet_weight_g))

```

```{r}
traits <- traits_2019 %>% 
  filter(dry_weight_g < wet_weight_g) %>%  # removing incorrect weights
  filter(sla < 65) %>% # there is one big outlier, and I don't think the dry weight is correct
  mutate(log_ldmc = log(ldmc)) %>% 
  unite(c("climate", "new_block", "treatment"), col = "plot", sep = "-", remove = FALSE) %>% 
  drop_na()
  
ggplot(data = traits, aes(x = sla, color = treatment)) +
  geom_histogram()
  
# SLA
# without block
model_1 <-  glmmTMB(data = traits, sla ~ treatment * species + climate * species, family = gaussian, na.action = na.fail)
dredge(model_1) # best fit model is climate and species; AIC = 1198.3
model_1 <- model_1 <- glmmTMB(data = traits, sla ~ climate + species, family = gaussian, na.action = na.fail)
simulateResiduals(model_1, plot= T) # doesn't pass outlier test

# with block (old)
model_2 <-  glmmTMB(data = traits, sla ~ treatment * species + climate * species + (1|new_block), family = gaussian, na.action = na.fail)
dredge(model_2) # best fit model is climate and species; AIC = 1190.2
model_2 <-  glmmTMB(data = traits, sla ~ climate + species + (1|new_block), family = gaussian, na.action = na.fail)
simulateResiduals(model_2, plot= T) # doesn't pass outlier test

# with block (new)
# model_3 <- glmmTMB(data = traits, sla ~ treatment * species + climate * species + (1|new_block/plot), family = gaussian, na.action = na.fail)
# this is the same model as above because I have a unique name for each block and plot
model_3 <- glmmTMB(data = traits, sla ~ treatment * species + climate * species + (1|new_block) + (1|plot), family = gaussian, na.action = na.fail)
dredge(model_3) # best fit is climate and species; AIC = 1206.0
model_3 <- glmmTMB(data = traits, sla ~ climate + species + (1|new_block/plot), family = gaussian, na.action = na.fail)
simulateResiduals(model_3, plot= T) # does not pass outlier test

```

```{r}
# 
# # log transformation
# model_1 <- glmmTMB(data = traits,log_sla ~ treatment * climate + species + (1|new_block), family = gaussian, na.action = na.fail)
# dredge(model_1) # best fit model has climate and species
# model_1 <- glmmTMB(data = traits, log_sla ~ climate + species + (1|new_block), family = gaussian, na.action = na.fail)
# 
# simulateResiduals(model_1, plot= T) # doesn't pass KS test
# shapiro.test(residuals(model_1)) # not normal
# 
# # log+1 transformation
# model_1 <- glmmTMB(data = traits, log_sla_plus ~ treatment * climate + species + (1|new_block), family = gaussian, na.action = na.fail)
# dredge(model_1) # best fit model has climate and species
# model_1 <- glmmTMB(data = traits, log_sla_plus ~ climate + species + (1|new_block), family = gaussian, na.action = na.fail)
# 
# simulateResiduals(model_1, plot= T)  # doesn't pass KS test
# shapiro.test(residuals(model_1)) # not normal
# 
# # square root transformation
# model_1 <- glmmTMB(data = traits, sqrt_sla ~ treatment * climate + species + (1|new_block), family = gaussian, na.action = na.fail)
# dredge(model_1) # best fit model has climate and species
# model_1 <- glmmTMB(data = traits, sqrt_sla ~ climate + species + (1|new_block), family = gaussian, na.action = na.fail)
# 
# simulateResiduals(model_1, plot= T) # doesn't pass KS test
# shapiro.test(residuals(model_1)) # not normal
# 
# # squared transformation
# model_1 <- glmmTMB(data = traits, sla2 ~ treatment * climate + species + (1|new_block), family = gaussian, na.action = na.fail) 
# dredge(model_1)
# 
# model_1 <- glm(data = traits, sla ~ treatment * climate + species, family = gaussian, na.action = na.fail)
# dredge(model_1) # best fit includes climate and species
# model_1 <- glm(data = traits, sla ~ climate + species, family = gaussian, na.action = na.fail)
# 
# simulateResiduals(model_1, plot= T) # so bad
# shapiro.test(residuals(model_1)) # not normal
# 
# 
# # un-transformed, Gamma
# model_1  <- glmmTMB(data = traits, sla ~ treatment * climate + species + (1|new_block), family = Gamma(link = "log"))
# dredge(model_1)
# model_1  <- glmmTMB(data = traits, sla ~ climate + species + (1|new_block), family = Gamma(link = "log"))
# 
# simulateResiduals(model_1, plot= T) # doesn't pass KS test
# shapiro.test(residuals(model_1)) # not normal
# 
# # log transformed, Gamma
# model_1  <- glmmTMB(data = traits, log_sla ~ treatment * climate + species + (1|new_block), family = Gamma(link = "log"))
# dredge(model_1)
# model_1  <- glmmTMB(data = traits, log_sla ~ climate + species + (1|new_block), family = Gamma(link = "log"))
# 
# simulateResiduals(model_1, plot= T) # doesn't pass KS test
# shapiro.test(residuals(model_1)) # not normal
# 
# # log+1 transformed, Gamma
# model_1  <- glmmTMB(data = traits, log_sla_plus ~ treatment * climate + species + (1|new_block), family = Gamma(link = "log"))
# dredge(model_1)
# model_1  <- glmmTMB(data = traits, log_sla_plus ~ climate + species + (1|new_block), family = Gamma(link = "log"))
# 
# simulateResiduals(model_1, plot= T) # doesn't pass KS test
# shapiro.test(residuals(model_1)) # not normal
# 
# # sqrt transformed, Gamma
# model_1  <- glmmTMB(data = traits, sqrt_sla ~ treatment * climate + species + (1|new_block), family = Gamma(link = "log"))
# dredge(model_1)
# model_1  <- glmmTMB(data = traits, sqrt_sla ~ climate + species + (1|new_block), family = Gamma(link = "log"))
# 
# simulateResiduals(model_1, plot= T) # doesn't pass KS test
# shapiro.test(residuals(model_1)) # not normal
# 
# # power transformed, Gamma
# model_1  <- glmmTMB(data = traits, sla2 ~ treatment * climate + species + (1|new_block), family = Gamma(link = "log"))
# dredge(model_1)
# model_1  <- glmmTMB(data = traits, sla2 ~ climate + species + (1|new_block), family = Gamma(link = "log"))
# 
# simulateResiduals(model_1, plot= T) # better
# shapiro.test(residuals(model_1)) # not normal

```

## GLMs for individual species change

- Does not include block because I only have the mean for each species at each plot
- Some species are present in all climate/treatment, but some are not
- Based off of 2019 abundance data and 2019 trait collection data (LA, SLA, LDMC)

### Models:

**What is the effect of climate and grazing on individual species trait changes?**

`glm(trait ~ Climate * Treatment, family = gaussian)`

- planning to do for LA, SLA, and LDMC (from field collection in 2019) for a subset of species
- could do for seed mass and leaf N, but those values would be from TRY Database
- species chosen as those that are present across as many climate/treatment combinations as possible
- unfortunately, I scanned and weighed the leaves together to get averages, so I have lost the ability to add block to my models
- need to think of how I would deal with multiple comparisons (bonferroni correction?)

```{r}
#writing function to take species name and test model with dredge

model_test <- function(species_name, trait){
  temp_data <- traits_19[traits_19$Species == species_name,] %>% 
    drop_na()
  glm <- glm(data = temp_data, trait ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
  print(dredge(glm))
}

```
### Bromus diandrus
```{r}
bro_dia <- traits %>% 
  filter(species == "Bromus diandrus") %>% 
  mutate(log_sla = log(sla))

ggplot(data = bro_dia, aes(x = sla, color = treatment)) +
  geom_histogram()

ggplot(data = bro_dia, aes(x = ldmc, color = treatment)) +
  geom_histogram()

ggplot(data = bro_dia, aes(x = indiv_area, color = treatment)) +
  geom_histogram()

bro_dia %>% 
  group_by(new_block) %>% 
  count()

lapply(bro_dia["new_block"], unique)

```
#### LA
Best fit: LA ~ + (1|block)
```{r}
# model
bro_dia_la <- glmmTMB(data = bro_dia, indiv_area ~ treatment * climate + (1|new_block) , family = gaussian, na.action = na.fail)
dredge(bro_dia_la) # best-fit intercept only
bro_dia_la <- glmmTMB(data = bro_dia, indiv_area ~ 1 + (1|new_block), family = "gaussian", na.action = na.fail)

simulateResiduals(bro_dia_la, plot= T) # looks good

```
#### SLA
SLA ~ 1 + (1|block)
* need to do averaging
```{r}
# model
bro_dia_sla <- glmmTMB(data = bro_dia, sla ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(bro_dia_sla) # best fit model is just intercept, but would need to do averaging
bro_dia_sla <- glmmTMB(data = bro_dia, sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(bro_dia_sla, plot= T) # ok?
shapiro.test(residuals(bro_dia_sla)) # normal
```
#### LDMC
LDMC ~ 1 + (1|block)
* need to do averaging
```{r}
# model
bro_dia_ldmc <- glmmTMB(data = bro_dia, ldmc ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(bro_dia_ldmc) # best fit model is intercept
bro_dia_ldmc <- glmmTMB(data = bro_dia, ldmc ~ 1 + (1|new_block), family = gaussian, na.action = na.fail) # get model convergence

simulateResiduals(bro_dia_ldmc, plot= T) # ok
shapiro.test(residuals(bro_dia_ldmc)) # normal
```
### Festuca myuros
```{r}
fes_myu <- traits %>% 
  filter(species == "Festuca myuros") %>%
  mutate(log_area = log(indiv_area)) %>% 
  mutate(log_sla = log(sla)) %>% 
  mutate(log_ldmc = log(ldmc)) %>% 
  drop_na()

fes_myu %>%
  pivot_longer(cols = indiv_area:ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")
```
#### LA
best fit: log(LA) ~ climate + (1|block)
```{r}
fes_myu_la <- glmmTMB(data = fes_myu, indiv_area ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(fes_myu_la) # get convergence error; best fit is climate only
fes_myu_la <- glmmTMB(data = fes_myu, indiv_area ~ climate + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(fes_myu_la, plot= T) # not ok
shapiro.test(residuals(fes_myu_la)) # not normal

# log transformation
fes_myu_la <- glmmTMB(data = fes_myu, log_area ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(fes_myu_la) # best fit model is climate only
fes_myu_la <- glmmTMB(data = fes_myu, log_area ~ climate + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(fes_myu_la, plot= T) #ok?
shapiro.test(residuals(fes_myu_la)) # normal
```
#### SLA
best fit: SLA ~ 1 + (1|block)
*need to average
```{r}
fes_myu_sla <- glmmTMB(data = fes_myu, sla ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(fes_myu_sla) # get convergence error; best fit is intercept only; need to average
fes_myu_sla <- glmmTMB(data = fes_myu, sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(fes_myu_sla, plot= T) # ok?
shapiro.test(residuals(fes_myu_sla)) # not normal

# # log transformation
# fes_myu_sla <- glmmTMB(data = fes_myu, log_sla ~ treatment * climate + (1|new_block) + (1|plot), family = gaussian, na.action = na.fail)
# dredge(fes_myu_sla) # get convergence error; best fit is intercept only
# fes_myu_sla <- glmmTMB(data = fes_myu, log_sla ~ 1 + (1|new_block) + (1|plot), family = gaussian, na.action = na.fail)
# 
# simulateResiduals(fes_myu_sla, plot= T) # ok
# shapiro.test(residuals(fes_myu_sla)) # normal
```
#### LDMC
LDMC ~ 1 + (1|block)
```{r}
fes_myu_ldmc <- glmmTMB(data = fes_myu, ldmc ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(fes_myu_ldmc) # convergence error, best fit is intercept
fes_myu_ldmc <- glmmTMB(data = fes_myu, ldmc ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(fes_myu_ldmc, plot= T) # ok?
shapiro.test(residuals(fes_myu_ldmc)) # normal
```
### Bromus hordeaceus
```{r}
bro_hor <- traits %>% 
  filter(species == "Bromus hordeaceus") %>%
  mutate(log_area = log(indiv_area)) %>% 
  mutate(log_sla = log(sla)) %>% 
  drop_na()

bro_hor %>%
  pivot_longer(cols = indiv_area:ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")

```
#### LA
LA ~ 1 + (1|block)
* need to do averaging
```{r}
bro_hor_la <- glmmTMB(data = bro_hor, indiv_area ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(bro_hor_la) # get convergence error, best fit is intercept
bro_hor_la <- glmmTMB(data = bro_hor, indiv_area ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(bro_hor_la, plot= T) # good
shapiro.test(residuals(bro_hor_la)) # not normal
```
#### SLA
SLA ~ 1 + (1|block)
* need to do averaging
```{r}
bro_hor_sla <- glmmTMB(data = bro_hor, sla ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(bro_hor_sla) # get convergence error, best fit is climate
bro_hor_sla <- glmmTMB(data = bro_hor, sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(bro_hor_sla, plot= T) # fine
shapiro.test(residuals(bro_hor_sla)) # normal
```
#### LDMC
LDMC ~ treatment + (1|block)
```{r}
bro_hor_ldmc <- glmmTMB(data = bro_hor, ldmc ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(bro_hor_ldmc) # convergence error; best fit model is treatment
bro_hor_ldmc <- glmmTMB(data = bro_hor, ldmc ~ treatment + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(bro_hor_ldmc, plot= T) # good
shapiro.test(residuals(bro_hor_ldmc)) # normal
```
### Bromus tectorum
```{r}
bro_tec <- traits %>% 
  filter(species == "Bromus tectorum") %>%
  mutate(log_ldmc = log(ldmc)) %>% 
  drop_na()

bro_tec %>%
  pivot_longer(cols = indiv_area:log_ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")
```
#### LA
* has huge outlier
```{r}
bro_tec_la <- glmmTMB(data = bro_tec, indiv_area ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(bro_tec_la) # convergence proglem; best fit is intercept
bro_tec_la <- glmmTMB(data = bro_tec, indiv_area ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(bro_tec_la, plot= T) # so bad
shapiro.test(residuals(bro_tec_la)) # 
```
#### SLA
SLA ~ 1 ~ (1|block)
*need to do averaging
```{r}
bro_tec_sla <- glmmTMB(data = bro_tec, sla ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(bro_tec_sla) # best fit model is intercept, best fit is intercept
bro_tec_sla <- glmmTMB(data = bro_tec, sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(bro_tec_sla, plot= T) # good
shapiro.test(residuals(bro_tec_sla)) # normal
```
#### LDMC

```{r}
bro_tec_ldmc <- glmmTMB(data = bro_tec, ldmc ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(bro_tec_ldmc) # convergence warning; best fit is intercept only
bro_tec_ldmc <- glmmTMB(data = bro_tec, ldmc ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(bro_tec_ldmc, plot= T) # does not pass KS test

# log transformation
bro_tec_ldmc <- glmmTMB(data = bro_tec, log_ldmc ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(bro_tec_ldmc) # best fit is intercept only
bro_tec_ldmc <- glmmTMB(data = bro_tec, log_ldmc ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(bro_tec_ldmc, plot= T) # does not pass KS test
```
### Hordeum murium
```{r}
hor_mur <- traits %>% 
  filter(species == "Hordeum murinum") %>%
  mutate(log_ldmc = log(ldmc)) %>% 
  mutate(log_la = log(indiv_area)) %>% 
  drop_na()

hor_mur %>%
  pivot_longer(cols = indiv_area:ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")
```
#### LA
la ~ 1 + (1|block)
```{r}
hor_mur_la <- glmmTMB(data = hor_mur, indiv_area ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(hor_mur_la) # get convergece warning; best fit intercept only
hor_mur_la <- glmmTMB(data = hor_mur, indiv_area ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(hor_mur_la, plot=T) # good
shapiro.test(residuals(hor_mur_la)) # normal

```
#### SLA
SLA ~ 1 + (1|block)
```{r}
hor_mur_sla <- glmmTMB(data = hor_mur, sla ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(hor_mur_sla) # convergence warning; best fit model is intercept
hor_mur_sla <- glmmTMB(data = hor_mur, sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(hor_mur_sla, plot= T) # good
shapiro.test(residuals(hor_mur_sla)) # normal
```
#### LDMC
LDMC ~ 1 + (1|block)
```{r}
hor_mur_ldmc <- glmmTMB(data = hor_mur, ldmc ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(hor_mur_ldmc) # convergence warning; best fit model is intercept
hor_mur_ldmc <- glmmTMB(data = hor_mur, ldmc ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(hor_mur_ldmc, plot= T) # 
shapiro.test(residuals(hor_mur_ldmc)) # 
```
### Erodium cicutarium
```{r}
ero_cic <- traits %>% 
  filter(species == "Erodium cicutarium") %>%
  mutate(log_ldmc = log(ldmc)) %>% 
  drop_na()

ero_cic %>%
  pivot_longer(cols = indiv_area:ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")
```
#### LA
LA ~ climate + (1|block)
* need to do averaging
```{r}

ero_cic_la <- glmmTMB(data = ero_cic, indiv_area ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(ero_cic_la) # convergence problem; best fit is climate
ero_cic_la <- glmmTMB(data = ero_cic, indiv_area ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

# does data fit model?
simulateResiduals(ero_cic_la, plot=T) # ok
shapiro.test(residuals(ero_cic_la)) # normal
```
#### SLA
SLA ~ 1 + (1|block)
```{r}
ero_cic_sla <- glmmTMB(data = ero_cic, sla ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(ero_cic_sla) # convergence; best fit model is intercept only
ero_cic_sla <- glmmTMB(data = ero_cic, sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(ero_cic_sla, plot= T) # good
shapiro.test(residuals(ero_cic_sla)) # normal
```
#### LDMC
LDMC ~ 1 + (1|block)
* need to do averaging
```{r}
ero_cic_ldmc <- glmmTMB(data = ero_cic, ldmc ~ treatment * climate + (1|new_block), family = gaussian, na.action = na.fail)
dredge(ero_cic_ldmc) # convergence; best-fit model climate
ero_cic_ldmc <- glmmTMB(data = ero_cic, ldmc ~ climate + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(ero_cic_ldmc, plot= T) # gets a warming for too few data points
shapiro.test(residuals(ero_cic_ldmc)) # normal
```
### Galium aparine
```{r}
gal_apa <- traits %>% 
  filter(species == "Galium aparine") %>%
  mutate(log_ldmc = log(ldmc)) %>% 
  drop_na()

gal_apa %>%
  pivot_longer(cols = indiv_area:ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")
```
#### LA
LA ~ Climate + (1|Block)
```{r}
gal_apa_la <- glmmTMB(data = gal_apa, indiv_area ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail)
dredge(gal_apa_la) # convergence; best fit is intercept only
gal_apa_la <- glmmTMB(data = gal_apa, indiv_area ~ climate + (1|new_block), family = gaussian, na.action = na.fail)

# does data fit model?
simulateResiduals(gal_apa_la, plot=T) # good
shapiro.test(residuals(gal_apa_la)) # normal
```
#### SLA
SLA ~ Climate + (1|Block)
*need to do model averaging
```{r}
gal_apa_sla <- glmmTMB(data = gal_apa, sla ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail)
dredge(gal_apa_sla) # best fit climate only, need to do model averaging
gal_apa_sla <- glmmTMB(data = gal_apa, sla ~ climate + (1|new_block), family = gaussian, na.action = na.fail)

# does data fit model?
simulateResiduals(gal_apa_sla, plot=T) # good
shapiro.test(residuals(gal_apa_sla)) # normal
```
#### LDMC
LDMC ~ Climate + (1|Block)
```{r}
gal_apa_ldmc <- glmmTMB(data = gal_apa, ldmc ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # model convergence
dredge(gal_apa_ldmc ) # convergence; best fit climate only
gal_apa_ldmc <- glmmTMB(data = gal_apa, ldmc ~ climate + (1|new_block), family = gaussian, na.action = na.fail) # model convergence

simulateResiduals(gal_apa_ldmc, plot=T) # ok?
shapiro.test(residuals(gal_apa_ldmc )) # not normal

# # log transformation
# gal_apa_ldmc <- glmmTMB(data = gal_apa, log_ldmc ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail)
# dredge(gal_apa_ldmc) # bets fit is climate only
# gal_apa_ldmc <- glmmTMB(data = gal_apa, log_ldmc ~ climate + (1|new_block), family = gaussian, na.action = na.fail)
# 
# simulateResiduals(gal_apa_ldmc, plot=T) # ok
# shapiro.test(residuals(gal_apa_ldmc )) # normal

```
### Plagiobothrys nothofulvus
```{r}
pla_not <- traits %>% 
  filter(species == "Plagiobothrys nothofulvus") %>%
  mutate(log_ldmc = log(ldmc)) %>% 
  mutate(log_la = log(indiv_area)) %>% 
  mutate(log_sla = log(sla)) %>% 
  drop_na()

pla_not %>%
  pivot_longer(cols = indiv_area:ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")
```
#### LA
LA ~ 1 + (1|block)
*need to do averaging
```{r}
pla_not_la <- glmmTMB(data = pla_not, indiv_area ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail)
dredge(pla_not_la) #convergenct; best fit intercept only
pla_not_la <- glmmTMB(data = pla_not, indiv_area ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(pla_not_la, plot=T) # ok?
shapiro.test(residuals(pla_not_la)) # not normal

# # log transformation
# pla_not_la <- glmmTMB(data = pla_not, log_la ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail)
# dredge(pla_not_la) # best fit intercept only, but need to do averaging
# pla_not_la <- glmmTMB(data = pla_not, log_la ~ climate + (1|new_block), family = gaussian, na.action = na.fail)
# 
# simulateResiduals(pla_not_la, plot=T) # ok?
# shapiro.test(residuals(pla_not_la)) # normal

```
#### SLA
SLA ~ Climate + (1|Block)
*need to do averaging
```{r}
pla_not_sla <- glmmTMB(data = pla_not, sla ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail)
dredge(pla_not_sla) # best fit climate only; averaging
pla_not_sla <- glmmTMB(data = pla_not, sla ~ climate + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(pla_not_sla, plot=T) # good
shapiro.test(residuals(pla_not_sla)) # normal

# # log transformation
# pla_not_sla <- glmmTMB(data = pla_not, log_sla ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail)
# dredge(pla_not_sla) # best fit intercept only
# pla_not_sla <- glmmTMB(data = pla_not, log_sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)
# 
# simulateResiduals(pla_not_sla, plot=T) # ok?
# shapiro.test(residuals(pla_not_sla)) # not normal

```
#### LDMC 
```{r}
pla_not_ldmc <- glmmTMB(data = pla_not, ldmc ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # model convergence
pla_not_ldmc <- glmmTMB(data = pla_not, ldmc ~ climate * treatment, family = gaussian, na.action = na.fail)
dredge(pla_not_ldmc) # best fit model is intercept
pla_not_ldmc <- glmmTMB(data = pla_not, ldmc ~ 1, family = gaussian, na.action = na.fail)

simulateResiduals(pla_not_ldmc, plot=T) # does not pass KS test
shapiro.test(residuals(pla_not_ldmc)) # not normal

# log transforamtion
pla_not_ldmc <- glmmTMB(data = pla_not, log_ldmc ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # model convergence
dredge(pla_not_ldmc) # best fit is intercept only
pla_not_ldmc <- glmmTMB(data = pla_not, log_ldmc ~ 1 + (1|new_block), family = gaussian, na.action = na.fail) # model convergence

simulateResiduals(pla_not_ldmc, plot=T) # ok
shapiro.test(residuals(pla_not_ldmc)) # not normal
```
### Ribes californicum var. hesperium
```{r}
ribes <- traits %>% 
  filter(species == "Ribes") %>%
  mutate(log_ldmc = log(ldmc)) %>% 
  mutate(log_la = log(indiv_area)) %>% 
  mutate(log_sla = log(sla)) %>% 
  drop_na()

ribes %>%
  pivot_longer(cols = indiv_area:ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")
```
#### LA
```{r}
ribes_la <- glmmTMB(data = ribes, indiv_area ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # convergence problem
ribes_la <- glmmTMB(data = ribes, indiv_area ~ climate * treatment, family = gaussian, na.action = na.fail) # convergence problem
ribes_la <- glmmTMB(data = ribes, indiv_area ~ climate + treatment + (1|new_block), family = gaussian, na.action = na.fail)
dredge(ribes_la) # best fit intercept only
ribes_la <- glmmTMB(data = ribes, indiv_area ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(ribes_la, plot=T) # doesn't pass KS test
shapiro.test(residuals(ribes_la)) # not normal

# log transformation
ribes_la <- glmmTMB(data = ribes, log_la ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # convergence problem
ribes_la <- glmmTMB(data = ribes, log_la ~ climate * treatment, family = gaussian, na.action = na.fail) # convergence problem
ribes_la <- glmmTMB(data = ribes, log_la ~ climate + treatment + (1|new_block), family = gaussian, na.action = na.fail)
dredge(ribes_la) # best fit intercept only
ribes_la <- glmmTMB(data = ribes, indiv_area ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(ribes_la, plot=T) # doesn't pass KS test
shapiro.test(residuals(ribes_la)) # not normal
```
#### SLA
SLA ~ intercept + block
```{r}
ribes_sla <- glmmTMB(data = ribes, sla ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # convergence problem
ribes_sla <- glmmTMB(data = ribes, sla ~ climate * treatment, family = gaussian, na.action = na.fail) # convergence problem
ribes_sla <- glmmTMB(data = ribes, sla ~ climate + treatment + (1|new_block), family = gaussian, na.action = na.fail)
dredge(ribes_sla) # best fit intercept only
ribes_sla <- glmmTMB(data = ribes, sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(ribes_sla, plot=T) # ok?
shapiro.test(residuals(ribes_sla)) # not normal

# log transformation
ribes_sla <- glmmTMB(data = ribes, log_sla ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # convergence problem
ribes_sla <- glmmTMB(data = ribes, log_sla ~ climate * treatment, family = gaussian, na.action = na.fail) # convergence problem
ribes_sla <- glmmTMB(data = ribes, log_sla ~ climate + treatment + (1|new_block), family = gaussian, na.action = na.fail)
dredge(ribes_sla) # best fit intercept only
ribes_sla <- glmmTMB(data = ribes, log_sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(ribes_sla, plot=T) # ok?
shapiro.test(residuals(ribes_sla)) # not normal
```
#### LDMC
LDMC ~ climate
```{r}
ribes_ldmc <- glmmTMB(data = ribes, ldmc ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # convergence problem
ribes_ldmc <- glmmTMB(data = ribes, ldmc ~ climate * treatment, family = gaussian, na.action = na.fail) # convergence problem
ribes_ldmc <- glmmTMB(data = ribes, ldmc ~ climate + treatment + (1|new_block), family = gaussian, na.action = na.fail) # convergence problem
ribes_ldmc <- glmmTMB(data = ribes, ldmc ~ climate + treatment, family = gaussian, na.action = na.fail) 
dredge(ribes_ldmc)
ribes_ldmc <- glmmTMB(data = ribes, ldmc ~ climate, family = gaussian, na.action = na.fail)

simulateResiduals(ribes_ldmc, plot=T) # ok?
shapiro.test(residuals(ribes_ldmc)) # normal
```
### Symphoricarpos mollis (Mesic only)
```{r}
sym_mol <- traits %>% 
  filter(species == "Symphoricarpos mollis") %>%
  mutate(log_ldmc = log(ldmc)) %>% 
  mutate(log_sla = log(sla)) %>% 
  drop_na()

sym_mol %>%
  pivot_longer(cols = indiv_area:ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")
```
#### LA
LA ~ 1 + block
```{r}
sym_mol_la <- glmmTMB(data = sym_mol, indiv_area ~ treatment + (1|new_block), family = gaussian, na.action = na.fail) #only at Mesic climate
dredge(sym_mol_la) # best fit intercept only
sym_mol_la <- glmmTMB(data = sym_mol, indiv_area ~ 1 + (1|new_block), family = gaussian, na.action = na.fail) 

simulateResiduals(sym_mol_la, plot=T) # ok?
shapiro.test(residuals(sym_mol_la)) # normal
```
#### SLA

```{r}
sym_mol_sla <- glmmTMB(data = sym_mol, sla ~ treatment + (1|new_block), family = gaussian, na.action = na.fail) #only at Mesic climate
dredge(sym_mol_sla) # best fit intercept only
sym_mol_sla <- glmmTMB(data = sym_mol, sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail) 

simulateResiduals(sym_mol_sla, plot=T) # not ok
shapiro.test(residuals(sym_mol_sla)) # not normal

# log transformation
sym_mol_sla <- glmmTMB(data = sym_mol, log_sla ~ treatment + (1|new_block), family = gaussian, na.action = na.fail) #only at Mesic climate
dredge(sym_mol_sla) # best fit intercept only
sym_mol_sla <- glmmTMB(data = sym_mol, log_sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail) #only at Mesic climate

simulateResiduals(sym_mol_sla, plot=T) # not ok
shapiro.test(residuals(sym_mol_sla)) # not normal
```
#### LDMC
LDMC ~ 1 + Block
```{r}
sym_mol_ldmc <- glmmTMB(data = sym_mol, ldmc ~ treatment + (1|new_block), family = gaussian, na.action = na.fail) #only at Mesic climate
dredge(sym_mol_ldmc) # best fit intercept only
sym_mol_ldmc <- glmmTMB(data = sym_mol, ldmc ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(sym_mol_ldmc, plot=T) # ok?
shapiro.test(residuals(sym_mol_ldmc)) # normal
```
### Ericameria nauseosa (only at Intermediate and Mesic)
```{r}
eri_nau <- traits %>% 
  filter(species == "Ericameria nauseosa") %>%
  mutate(log_ldmc = log(ldmc)) %>% 
  drop_na()

eri_nau %>%
  pivot_longer(cols = indiv_area:ldmc,
               names_to = "traits",
               values_to = "value") %>%
  ggplot(aes(x = climate, y = value, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  facet_grid(~ traits, scales = "free")
```
#### LA
LA ~ 1 + block
```{r}
eri_nau_la <- glmmTMB(data = eri_nau, indiv_area ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # model convergence
eri_nau_la <- glmmTMB(data = eri_nau, indiv_area ~ climate * treatment, family = gaussian, na.action = na.fail) # model convergence
eri_nau_la <- glmmTMB(data = eri_nau, indiv_area ~ climate + treatment + (1|new_block), family = gaussian, na.action = na.fail) 
dredge(eri_nau_la) # best fit is intercept
eri_nau_la <- glmmTMB(data = eri_nau, indiv_area ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(eri_nau_la, plot=T) # ok?
shapiro.test(residuals(eri_nau_la)) # normal
```
#### SLA
SLA ~ 1 + block
```{r}
eri_nau_sla <- glmmTMB(data = eri_nau, sla ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # model convergence
eri_nau_sla <- glmmTMB(data = eri_nau, sla ~ climate * treatment, family = gaussian, na.action = na.fail) # model convergence
eri_nau_sla <- glmmTMB(data = eri_nau, sla ~ climate + treatment + (1|new_block), family = gaussian, na.action = na.fail) 
dredge(eri_nau_sla) # best fit is intercept
eri_nau_sla <- glmmTMB(data = eri_nau, sla ~ 1 + (1|new_block), family = gaussian, na.action = na.fail)

simulateResiduals(eri_nau_sla, plot=T) # ok?
shapiro.test(residuals(eri_nau_sla)) # normal
```
#### LDMC
```{r}
eri_nau_ldmc <- glmmTMB(data = eri_nau, ldmc ~ climate * treatment + (1|new_block), family = gaussian, na.action = na.fail) # model convergence
eri_nau_ldmc <- glmmTMB(data = eri_nau, ldmc ~ climate * treatment, family = gaussian, na.action = na.fail) # model convergence
eri_nau_ldmc <- glmmTMB(data = eri_nau, ldmc ~ climate + treatment + (1|new_block), family = gaussian, na.action = na.fail) # convergence 
eri_nau_ldmc <- glmmTMB(data = eri_nau, ldmc ~ climate + treatment, family = gaussian, na.action = na.fail)
dredge(eri_nau_ldmc) # best fit is intercept
eri_nau_ldmc <- glmmTMB(data = eri_nau, ldmc ~ 1, family = gaussian, na.action = na.fail)

simulateResiduals(eri_nau_ldmc, plot=T) # ok?
shapiro.test(residuals(eri_nau_ldmc)) # not normal
```

## By functional group
```{r}
funct_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  mutate(sqrt_LA = sqrt(LA))

unique(funct_LA$Species)

# finding counts per group
funct_LA %>% 
  group_by(Climate, Treatment, functional_group, Species) %>% 
  count()

ggplot(funct_LA, aes(x = LA)) +
  geom_histogram() +
  theme_bw()

ggplot(funct_LA, aes(x = log_LA)) +
  geom_histogram() +
  theme_bw()

ggplot(funct_LA, aes(x = sqrt_LA)) +
  geom_histogram() +
  theme_bw()

shapiro.test(funct_LA$log_LA)

shapiro.test(funct_LA$sqrt_LA)

```
### GLMMs
```{r}
# Ideal model on un-transformed data:
funct_glmm <- glmmTMB(data = funct_LA, LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = gaussian)
dredge(funct_glmm) # best model only climate
funct_glmm <- glmmTMB(data = funct_LA, LA ~ Climate + (1|Species), family = gaussian)

simulateResiduals(funct_glmm, plot= T) # not good
shapiro.test(residuals(funct_glmm)) # not normal

# Trying with log transformation:
funct_glmm <- glmmTMB(data = funct_LA, log_LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = gaussian)
dredge(funct_glmm)
funct_glmm <- glmmTMB(data = funct_LA, log_LA ~ Climate + (1|Species), family = gaussian)

simulateResiduals(funct_glmm, plot= T) # not good
shapiro.test(residuals(funct_glmm)) # not normal

# Trying Gamma family with un-transformed
funct_glmm <- glmmTMB(data = funct_LA, LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = Gamma(link = "log"))
dredge(funct_glmm)
funct_glmm <- glmmTMB(data = funct_LA, LA ~ Climate + (1|Species), family = Gamma(link = "log"))

simulateResiduals(funct_glmm, plot= T) # not good
shapiro.test(residuals(funct_glmm)) # not normal

# Trying gaussian with square root transform
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = gaussian)
dredge(funct_glmm) # best model only climate
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + (1|Species), family = gaussian)

simulateResiduals(funct_glmm, plot= T) # not good
shapiro.test(residuals(funct_glmm)) # not normal

# gamma with square root
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = Gamma(link = "sqrt"))
dredge(funct_glmm) # best model only climate
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + (1|Species), family = Gamma(link = "sqrt"))

simulateResiduals(funct_glmm, plot= T) # good
shapiro.test(residuals(funct_glmm)) # not normal

# gamma with square root
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + Treatment + Climate:Treatment + functional_group + (1|Species), family = Gamma(link = "log"))
dredge(funct_glmm) # best model only climate
funct_glmm <- glmmTMB(data = funct_LA, sqrt_LA ~ Climate + (1|Species), family = Gamma(link = "log"))

simulateResiduals(funct_glmm, plot= T) # good
shapiro.test(residuals(funct_glmm)) # not normal

```
### GLMs by group
```{r}
grass_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "grass") %>% 
  mutate(sqrt_LA = sqrt(LA))

shrub_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "shrub") %>% 
  mutate(sqrt_LA = sqrt(LA)) %>% 
  mutate(inv_LA = 1 / LA)

forb_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "forb") %>% 
  mutate(sqrt_LA = sqrt(LA)) %>% 
  mutate(inv_LA = 1 / LA)

shapiro.test(forb_LA$log_LA) #normal
shapiro.test(shrub_LA$log_LA) #not normal
shapiro.test(grass_LA$log_LA) #not normal
shapiro.test(shrub_LA$sqrt_LA) #not normal
shapiro.test(grass_LA$sqrt_LA) #normal
shapiro.test(shrub_LA$inv_LA) #not normal

# just impact of functional group
funct_glm <- glm(data = funct_LA, LA ~ functional_group, family = Gamma, na.action = na.fail)
dredge(funct_glm)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

emmeans(funct_glm, pairwise ~ functional_group)

# with climate, treatment, and functional group
funct_glm <- glm(data = funct_LA, LA ~ Climate * Treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_glm)
funct_glm <- glm(data = funct_LA, LA ~ Climate + functional_group, family = gaussian, na.action = na.fail)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

# log transform
funct_glm <- glm(data = funct_LA, log_LA ~ Climate * Treatment * functional_group, family = gaussian, na.action = na.fail)
dredge(funct_glm)
funct_glm <- glm(data = funct_LA, log_LA ~ Climate + functional_group, family = gaussian, na.action = na.fail)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

# gamma distribution
funct_glm <- glm(data = funct_LA, LA ~ Climate + Treatment + functional_group, family = Gamma, na.action = na.fail)
dredge(funct_glm)
funct_glm <- glm(data = funct_LA, LA ~ Climate + functional_group, family = Gamma, na.action = na.fail)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

# gamma with log link
funct_glm <- glm(data = funct_LA, LA ~ Climate + Treatment + functional_group, family = Gamma(link = log), na.action = na.fail)
dredge(funct_glm)
funct_glm <- glm(data = funct_LA, LA ~ Climate + functional_group, family = Gamma(link = log), na.action = na.fail)

simulateResiduals(funct_glm, plot= T) # not normal
shapiro.test(residuals(funct_glm)) # not normal

#random effect with gaussian
funct_glm <- glm(data = funct_LA, LA ~ Climate + Treatment + functional_group + (1|fact_Species), family = "gaussian")
```

```{r}
grass_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "grass") %>% 
  mutate(sqrt_LA = sqrt(LA))

grass_LA

grass_glm <- glm(data = grass_LA, LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, LA ~ 1, family = "gaussian", na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

grass_glm <- glm(data = grass_LA, log_LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, log_LA ~ 1, family = "gaussian", na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

ggplot(grass_LA, aes(x = LA)) +
  geom_histogram() +
  theme_bw()

grass_glm <- glm(data = grass_LA, LA ~ Climate + Treatment, family = Gamma, na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, LA ~ 1, family = Gamma, na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

grass_glm <- glm(data = grass_LA, log_LA ~ Climate + Treatment, family = Gamma, na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, log_LA ~ 1, family = Gamma, na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

grass_glm <- glm(data = grass_LA, LA ~ Climate + Treatment, family = Gamma(link = log), na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, LA ~ 1, family = Gamma(link=log), na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # not normal

grass_glm <- glm(data = grass_LA, sqrt_LA ~ Climate + Treatment, family = gaussian, na.action = na.fail)
dredge(grass_glm)
grass_glm <- glm(data = grass_LA, sqrt_LA ~ 1, family = gaussian, na.action = na.fail)

simulateResiduals(grass_glm, plot= T) # not normal
shapiro.test(residuals(grass_glm)) # normal
```

```{r}
shrub_LA <- traits_19 %>% 
  drop_na(LA) %>% 
  mutate(log_LA = log(LA)) %>% 
  mutate(fact_Species = as.factor(Species)) %>% 
  dplyr::filter(functional_group == "shrub") %>% 
  mutate(sqrt_LA = sqrt(LA)) %>% 
  mutate(inv_LA = 1 / LA)

shrub_glm <- glm(data = shrub_LA, LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
boxCox(shrub_glm)

shrub_glm <- glm(data = shrub_LA, LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, LA ~ Climate, family = "gaussian", na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

shrub_glm <- glm(data = shrub_LA, log_LA ~ Climate * Treatment, family = "gaussian", na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, log_LA ~ Climate, family = "gaussian", na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

ggplot(shrub_LA, aes(x = LA)) +
  geom_histogram(bins = 100) +
  theme_bw()

ggplot(shrub_LA, aes(x = log_LA)) +
  geom_histogram(bins=100) +
  theme_bw()

ggplot(shrub_LA, aes(x = inv_LA)) +
  geom_histogram(bins=100) +
  theme_bw()

shrub_glm <- glm(data = shrub_LA, LA ~ Climate + Treatment, family = Gamma, na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, LA ~ Climate, family = Gamma, na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

shrub_glm <- glm(data = shrub_LA, log_LA ~ Climate + Treatment, family = Gamma, na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, log_LA ~ Climate, family = Gamma, na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

shrub_glm <- glm(data = shrub_LA, LA ~ Climate + Treatment, family = Gamma(link = log), na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, LA ~ Climate, family = Gamma(link=log), na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # not normal

shrub_glm <- glm(data = shrub_LA, sqrt_LA ~ Climate + Treatment, family = gaussian, na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, sqrt_LA ~ Climate, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # normal

shrub_glm <- glm(data = shrub_LA, inv_LA ~ Climate + Treatment, family = gaussian, na.action = na.fail)
dredge(shrub_glm)
shrub_glm <- glm(data = shrub_LA, inv_LA ~ Climate, family = gaussian, na.action = na.fail)

simulateResiduals(shrub_glm, plot= T) # not normal
shapiro.test(residuals(shrub_glm)) # normal
```

```{r}
# # TRY Database search to fill in missing species
# TRY_DB_1 <- read_csv("Datasheets/TRY_DB_june_2020.csv") %>% 
#   filter(ValueKindName %in% c("Single", "Mean", "Best estimate")) %>%
#   dplyr::select(AccSpeciesName, TraitName, StdValue) %>% 
#   dplyr::group_by(AccSpeciesName, TraitName) %>% 
#   mutate(StdValue = as.numeric(StdValue)) %>% 
#   summarize(mean = mean(StdValue)) %>% 
#   rename(species_name = AccSpeciesName)
# 
# TRY_DB_2 <- read_csv("Datasheets/TRY_DB_Oct-18-20.csv") %>% 
#   filter(ValueKindName %in% c("Single", "Mean", "Best estimate")) %>%
#   dplyr::select(AccSpeciesName, TraitName, StdValue) %>% 
#   dplyr::group_by(AccSpeciesName, TraitName) %>% 
#   mutate(StdValue = as.numeric(StdValue)) %>% 
#   summarize(mean = mean(StdValue)) %>% 
#   rename(species_name = AccSpeciesName)
# 
# write.csv(TRY_DB_2, "TRY_DB_2.csv")
```